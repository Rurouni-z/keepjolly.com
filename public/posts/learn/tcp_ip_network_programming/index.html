<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.140.2"><meta name="theme-color" content="#fff" />
    <meta name="color-scheme" content="light dark">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>TCP_IPç½‘ç»œç¼–ç¨‹ | æ‚ é—²ã®å°å±‹</title>

    <link rel="stylesheet" href="/css/meme.min.css" />

    
    
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js" defer></script><script src="/js/meme.min.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Cinzel&#43;Decorative:wght@700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Cinzel&#43;Decorative:wght@700&amp;display=swap" /></noscript>

    <meta name="author" content="Rurouni" /><meta name="description" content="ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­— serverï¼š
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;sys/socket.h&gt; int main(){ int sockfd; int clnt_sock; struct sockaddr_in serv_addr; struct sockaddr_in clnt_addr; // åˆ›å»ºå¥—æ¥å­— sockfd = socket(PF_INET, SOCK_STREAM, 0); if (sockfd == -1) exit(0); // ç«¯å£å¤ç”¨ï¼Œé˜²æ­¢address in use int one = 1; setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;one, sizeof(one)); // bindåœ°å€ memset(&amp;serv_addr, 0, sizeof(sockaddr_in)); serv_addr.sin_family = AF_INET; serv_addr.sin_addr.s_addr = htonl(INADDR_ANY); serv_addr.sin_port = htons(8888); if (bind(sockfd, ( struct sockaddr*)&amp;serv_addr, sizeof(serv_addr))&lt; 0) exit(0); // å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿å…¥ if (listen(sockfd, 1) &lt; 0) exit(0); // å¯ä»¥ä¸å®¢æˆ·ç«¯é€šä¿¡ socklen_t clnt_addr_size; clnt_addr_size = sizeof(clnt_addr); // ä¸èƒ½ä½¿ç”¨(socklen_t*)clnt_addr_sizeä½¿ç”¨(socklen_t*)&amp;clnt_addr_size clnt_sock = accept(sockfd, (struct sockaddr*)&amp;clnt_addr, &amp;clnt_addr_size); if (clnt_sock &lt; 0) exit(0); // å‘é€æ•°æ® char message[] = &#34;Hello!&#34;; write(clnt_sock, message, sizeof(message)); close(clnt_sock); close(sockfd); return 0; } clientï¼š
â€¦â€¦" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="æ‚ é—²ã®å°å±‹" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="æ‚ é—²ã®å°å±‹" />
    <meta name="msapplication-starturl" content="../../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="http://localhost:1313/posts/learn/tcp_ip_network_programming/" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2023-08-13T22:41:54+08:00",
        "dateModified": "2024-05-03T14:50:48+08:00",
        "url": "http://localhost:1313/posts/learn/tcp_ip_network_programming/",
        "headline": "TCP_IPç½‘ç»œç¼–ç¨‹",
        "description": "ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­— serverï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e #include \u003cstring.h\u003e #include \u003cunistd.h\u003e #include \u003carpa/inet.h\u003e #include \u003csys/socket.h\u003e int main(){ int sockfd; int clnt_sock; struct sockaddr_in serv_addr; struct sockaddr_in clnt_addr; // åˆ›å»ºå¥—æ¥å­— sockfd = socket(PF_INET, SOCK_STREAM, 0); if (sockfd == -1) exit(0); // ç«¯å£å¤ç”¨ï¼Œé˜²æ­¢address in use int one = 1; setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, \u0026one, sizeof(one)); // bindåœ°å€ memset(\u0026serv_addr, 0, sizeof(sockaddr_in)); serv_addr.sin_family = AF_INET; serv_addr.sin_addr.s_addr = htonl(INADDR_ANY); serv_addr.sin_port = htons(8888); if (bind(sockfd, ( struct sockaddr*)\u0026serv_addr, sizeof(serv_addr))\u003c 0) exit(0); // å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿å…¥ if (listen(sockfd, 1) \u003c 0) exit(0); // å¯ä»¥ä¸å®¢æˆ·ç«¯é€šä¿¡ socklen_t clnt_addr_size; clnt_addr_size = sizeof(clnt_addr); // ä¸èƒ½ä½¿ç”¨(socklen_t*)clnt_addr_sizeä½¿ç”¨(socklen_t*)\u0026clnt_addr_size clnt_sock = accept(sockfd, (struct sockaddr*)\u0026clnt_addr, \u0026clnt_addr_size); if (clnt_sock \u003c 0) exit(0); // å‘é€æ•°æ® char message[] = \"Hello!\"; write(clnt_sock, message, sizeof(message)); close(clnt_sock); close(sockfd); return 0; } clientï¼š\nâ€¦â€¦",
        "inLanguage" : "zh-CN",
        "articleSection": "posts",
        "wordCount":  12632 ,
        "image": ["https://pic.keepjolly.com/halo/blog/2023/06/20230607220100.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-1.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-2.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-3.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-4.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-5.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-6.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-7.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-8.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-9.png?imageMogr2/format/webp%7C","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-10.png?imageMogr2/format/webp%7C","https://camo.githubusercontent.com/e8059964da650325509a86c00916dc588b147221b21e0355ca13e6ee8126f667/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32312f6b5037526a782e706e67#from=url\u0026amp;id=SMxPg\u0026amp;originHeight=363\u0026amp;originWidth=513\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-11.png?imageMogr2/format/webp%7C","https://camo.githubusercontent.com/60042284b80365905816ec0f9ca8bcf8695895916bad37b1d6d30a716e85ba0f/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32312f6b5062686b442e706e67#from=url\u0026amp;id=Qy4jl\u0026amp;originHeight=295\u0026amp;originWidth=459\u0026amp;originalType=binary\u0026amp;ratio=1.2\u0026amp;rotation=0\u0026amp;showTitle=false\u0026amp;status=done\u0026amp;style=none\u0026amp;title=","https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-12.png?imageMogr2/format/webp%7C"],
        "author": {
            "@type": "Person",
            "url": "http://localhost:1313/",
            
        },
        "license": "åœ¨ä¿ç•™æœ¬æ–‡ä½œè€…åŠæœ¬æ–‡é“¾æ¥çš„å‰æä¸‹ï¼Œéå•†ä¸šç”¨é€”éšæ„è½¬è½½åˆ†äº«(æˆ‘ä¼šé«˜å¼ºåº¦è‡ªæœçš„å–”ğŸ‘Š)ã€‚",
        "publisher": {
            "@type": "Organization",
            "name": "æ‚ é—²ã®å°å±‹",
            "url": "http://localhost:1313/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "http://localhost:1313/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />



    



<meta property="og:title" content="TCP_IPç½‘ç»œç¼–ç¨‹" />
<meta property="og:description" content="ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­— serverï¼š
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;sys/socket.h&gt; int main(){ int sockfd; int clnt_sock; struct sockaddr_in serv_addr; struct sockaddr_in clnt_addr; // åˆ›å»ºå¥—æ¥å­— sockfd = socket(PF_INET, SOCK_STREAM, 0); if (sockfd == -1) exit(0); // ç«¯å£å¤ç”¨ï¼Œé˜²æ­¢address in use int one = 1; setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;one, sizeof(one)); // bindåœ°å€ memset(&amp;serv_addr, 0, sizeof(sockaddr_in)); serv_addr.sin_family = AF_INET; serv_addr.sin_addr.s_addr = htonl(INADDR_ANY); serv_addr.sin_port = htons(8888); if (bind(sockfd, ( struct sockaddr*)&amp;serv_addr, sizeof(serv_addr))&lt; 0) exit(0); // å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿å…¥ if (listen(sockfd, 1) &lt; 0) exit(0); // å¯ä»¥ä¸å®¢æˆ·ç«¯é€šä¿¡ socklen_t clnt_addr_size; clnt_addr_size = sizeof(clnt_addr); // ä¸èƒ½ä½¿ç”¨(socklen_t*)clnt_addr_sizeä½¿ç”¨(socklen_t*)&amp;clnt_addr_size clnt_sock = accept(sockfd, (struct sockaddr*)&amp;clnt_addr, &amp;clnt_addr_size); if (clnt_sock &lt; 0) exit(0); // å‘é€æ•°æ® char message[] = &#34;Hello!&#34;; write(clnt_sock, message, sizeof(message)); close(clnt_sock); close(sockfd); return 0; } clientï¼š
â€¦â€¦" />
<meta property="og:url" content="http://localhost:1313/posts/learn/tcp_ip_network_programming/" />
<meta property="og:site_name" content="æ‚ é—²ã®å°å±‹" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100.png?imageMogr2/format/webp%7C" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2023-08-13T22:41:54&#43;08:00" />
    <meta property="article:modified_time" content="2024-05-03T14:50:48&#43;08:00" />
    
    <meta property="article:section" content="posts" />


        <meta name="google-site-verification" content="mBjLYgXaXR8EAfTNbi4DTVC5KOJuBHpZDsmtgbgC6Rs" />

    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">æ‚ é—²ã®å°å±‹</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/categories/"><span class="menu-item-name">åˆ†ç±»</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><span class="menu-item-name">æ ‡ç­¾</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><span class="menu-item-name">å…³äº</span></a>
                </li>
            
        
            
                
                    
                    
                        <li class="menu-item">
                            <a id="theme-switcher" href="#"><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a>
                        </li>
                    
                
            
        
            
                <li class="menu-item search-item">
                        <form id="search" class="search" role="search">
    <label for="search-input"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label>
    <input type="search" id="search-input" class="search-input">
</form>

<template id="search-result" hidden>
    <article class="content post">
        <h2 class="post-title"><a class="summary-title-link"></a></h2>
        <summary class="summary"></summary>
        <div class="read-more-container">
            <a class="read-more-link">é˜…è¯»æ›´å¤š Â»</a>
        </div>
    </article>
</template>

                    </li>
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    
    <div class = "toc-wrapper">
        
<div class="post-toc" id="post-toc">
<aside>
    <header>
    <h4>æ–‡ç« ã®å­—æ•°: 12632</h4> 
    </header>
    
    
    <nav id="TableOfContents">
  <ol>
    <li><a href="#ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—">ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—</a>
      <ol>
        <li><a href="#åœ°å€æ—ä¸æ•°æ®åºåˆ—">åœ°å€æ—ä¸æ•°æ®åºåˆ—</a></li>
        <li><a href="#é—®é¢˜">é—®é¢˜</a></li>
      </ol>
    </li>
    <li><a href="#åŸºäºtcpçš„å®¢æˆ·ç«¯æœåŠ¡ç«¯">åŸºäºTCPçš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯</a>
      <ol>
        <li><a href="#tcpip-åè®®æ ˆ">TCP/IP åè®®æ ˆ</a></li>
        <li><a href="#tcpæµç¨‹">TCPæµç¨‹</a>
          <ol>
            <li><a href="#æœåŠ¡ç«¯">æœåŠ¡ç«¯</a></li>
            <li><a href="#å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</a></li>
            <li><a href="#echo-serverclient">echo server/client</a></li>
          </ol>
        </li>
        <li><a href="#é—®é¢˜-1">é—®é¢˜</a></li>
      </ol>
    </li>
    <li><a href="#åŸºäº-tcp-çš„æœåŠ¡ç«¯å®¢æˆ·ç«¯2">åŸºäº TCP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼ˆ2ï¼‰</a>
      <ol>
        <li><a href="#echo-clientçš„å®Œç¾å®ç°">echo clientçš„å®Œç¾å®ç°</a>
          <ol>
            <li><a href="#å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°">å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°</a></li>
            <li><a href="#é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯å®šä¹‰åº”ç”¨å±‚åè®®">é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯ï¼šå®šä¹‰åº”ç”¨å±‚åè®®</a></li>
          </ol>
        </li>
        <li><a href="#tcp-åŸç†">TCP åŸç†</a>
          <ol>
            <li><a href="#tcp-å¥—æ¥å­—ä¸­çš„-io-ç¼“å†²">TCP å¥—æ¥å­—ä¸­çš„ I/O ç¼“å†²</a></li>
            <li><a href="#tcp-å†…éƒ¨å·¥ä½œåŸç†">TCP å†…éƒ¨å·¥ä½œåŸç†</a>
              <ol>
                <li><a href="#1-ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥">1 ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥</a></li>
                <li><a href="#2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢">2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</a></li>
                <li><a href="#3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢">3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#åŸºäºudpçš„æœåŠ¡ç«¯å®¢æˆ·ç«¯">åŸºäºUDPçš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯</a>
      <ol>
        <li><a href="#udpåŸç†">UDPåŸç†</a></li>
        <li><a href="#udpå·¥ä½œåŸç†">UDPå·¥ä½œåŸç†</a></li>
        <li><a href="#ä»£ç å®ç°">ä»£ç å®ç°</a></li>
        <li><a href="#udp-çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨-connect-å‡½æ•°">UDP çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨ connect å‡½æ•°</a></li>
      </ol>
    </li>
    <li><a href="#ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥">ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥</a>
      <ol>
        <li><a href="#åŸºäº-tcp-çš„åŠå…³é—­">åŸºäº TCP çš„åŠå…³é—­</a>
          <ol>
            <li><a href="#é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„-shutdown-å‡½æ•°">é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„ shutdown å‡½æ•°</a></li>
            <li><a href="#ä¸ºä½•è¦åŠå…³é—­">ä¸ºä½•è¦åŠå…³é—­</a></li>
            <li><a href="#ä¸€ä¸ªä¼˜é›…çš„æµç¨‹">ä¸€ä¸ªä¼˜é›…çš„æµç¨‹</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#åŸŸååŠç½‘ç»œåœ°å€">åŸŸååŠç½‘ç»œåœ°å€</a>
      <ol>
        <li><a href="#åŸŸåç³»ç»Ÿ">åŸŸåç³»ç»Ÿ</a></li>
        <li><a href="#ipåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢">IPåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢</a>
          <ol>
            <li><a href="#é€šè¿‡åŸŸåè·å¾—ip">é€šè¿‡åŸŸåè·å¾—ip</a></li>
            <li><a href="#åˆ©ç”¨ipåœ°å€è·å–åŸŸå">åˆ©ç”¨IPåœ°å€è·å–åŸŸå</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹">å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹</a>
      <ol>
        <li><a href="#å¥—æ¥å­—å¯é€‰é¡¹å’Œ-io-ç¼“å†²å¤§å°">å¥—æ¥å­—å¯é€‰é¡¹å’Œ I/O ç¼“å†²å¤§å°</a>
          <ol>
            <li><a href="#getsockopt--setsockopt">getsockopt &amp; setsockopt</a></li>
            <li><a href="#so_sndbuf--so_rcvbuf">SO_SNDBUF &amp; SO_RCVBUF</a></li>
          </ol>
        </li>
        <li><a href="#so_reuseaddrimportant">SO_REUSEADDRï¼ˆimportantï¼‰</a>
          <ol>
            <li><a href="#time-wait-çŠ¶æ€">Time-wait çŠ¶æ€</a></li>
            <li><a href="#åœ°å€å†åˆ†é…">åœ°å€å†åˆ†é…</a></li>
          </ol>
        </li>
        <li><a href="#tcp_nodelay">TCP_NODELAY</a>
          <ol>
            <li><a href="#ç¦ç”¨-nagle-ç®—æ³•">ç¦ç”¨ Nagle ç®—æ³•</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯">å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯</a>
      <ol>
        <li><a href="#è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨">è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨</a>
          <ol>
            <li><a href="#ç†è§£è¿›ç¨‹">ç†è§£è¿›ç¨‹</a></li>
            <li><a href="#è°ƒç”¨-fork-å‡½æ•°åˆ›å»ºè¿›ç¨‹">è°ƒç”¨ fork å‡½æ•°åˆ›å»ºè¿›ç¨‹</a></li>
          </ol>
        </li>
        <li><a href="#åƒµå°¸è¿›ç¨‹">åƒµå°¸è¿›ç¨‹</a>
          <ol>
            <li><a href="#äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› ">äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› </a></li>
            <li><a href="#é”€æ¯åƒµå°¸è¿›ç¨‹-1åˆ©ç”¨-wait-å‡½æ•°">é”€æ¯åƒµå°¸è¿›ç¨‹ 1ï¼šåˆ©ç”¨ wait å‡½æ•°</a></li>
            <li><a href="#é”€æ¯åƒµå°¸è¿›ç¨‹-2ä½¿ç”¨-waitpid-å‡½æ•°">é”€æ¯åƒµå°¸è¿›ç¨‹ 2ï¼šä½¿ç”¨ waitpid å‡½æ•°</a></li>
          </ol>
        </li>
        <li><a href="#ä¿¡å·å¤„ç†">ä¿¡å·å¤„ç†</a>
          <ol>
            <li><a href="#ä¿¡å·ä¸-signal-å‡½æ•°">ä¿¡å·ä¸ signal å‡½æ•°</a></li>
            <li><a href="#åˆ©ç”¨-sigaction-å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†">åˆ©ç”¨ sigaction å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†</a></li>
            <li><a href="#åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹">åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹</a></li>
          </ol>
        </li>
        <li><a href="#åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨">åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨</a>
          <ol>
            <li><a href="#åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹">åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹</a></li>
            <li><a href="#é€šè¿‡-fork-å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦">é€šè¿‡ fork å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</a></li>
          </ol>
        </li>
        <li><a href="#åˆ†å‰²-tcp-çš„-io-ç¨‹åº">åˆ†å‰² TCP çš„ I/O ç¨‹åº</a></li>
      </ol>
    </li>
  </ol>
</nav>
    
    
</aside>
<a href="#" id="toc-toggle"></a>
</div>

<div class = "toc-phone">
    <nav class="contents">
  <h2 id="contents" class="contents-title">ç›®å½•</h2><ol class="toc">
    <li><a id="contents:ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—" href="#ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—">ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—</a>
      <ol>
        <li><a id="contents:åœ°å€æ—ä¸æ•°æ®åºåˆ—" href="#åœ°å€æ—ä¸æ•°æ®åºåˆ—">åœ°å€æ—ä¸æ•°æ®åºåˆ—</a></li>
        <li><a id="contents:é—®é¢˜" href="#é—®é¢˜">é—®é¢˜</a></li>
      </ol>
    </li>
    <li><a id="contents:åŸºäºtcpçš„å®¢æˆ·ç«¯æœåŠ¡ç«¯" href="#åŸºäºtcpçš„å®¢æˆ·ç«¯æœåŠ¡ç«¯">åŸºäºTCPçš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯</a>
      <ol>
        <li><a id="contents:tcpip-åè®®æ ˆ" href="#tcpip-åè®®æ ˆ">TCP/IP åè®®æ ˆ</a></li>
        <li><a id="contents:tcpæµç¨‹" href="#tcpæµç¨‹">TCPæµç¨‹</a>
          <ol>
            <li><a id="contents:æœåŠ¡ç«¯" href="#æœåŠ¡ç«¯">æœåŠ¡ç«¯</a></li>
            <li><a id="contents:å®¢æˆ·ç«¯" href="#å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</a></li>
            <li><a id="contents:echo-serverclient" href="#echo-serverclient">echo server/client</a></li>
          </ol>
        </li>
        <li><a id="contents:é—®é¢˜-1" href="#é—®é¢˜-1">é—®é¢˜</a></li>
      </ol>
    </li>
    <li><a id="contents:åŸºäº-tcp-çš„æœåŠ¡ç«¯å®¢æˆ·ç«¯2" href="#åŸºäº-tcp-çš„æœåŠ¡ç«¯å®¢æˆ·ç«¯2">åŸºäº TCP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼ˆ2ï¼‰</a>
      <ol>
        <li><a id="contents:echo-clientçš„å®Œç¾å®ç°" href="#echo-clientçš„å®Œç¾å®ç°">echo clientçš„å®Œç¾å®ç°</a>
          <ol>
            <li><a id="contents:å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°" href="#å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°">å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°</a></li>
            <li><a id="contents:é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯å®šä¹‰åº”ç”¨å±‚åè®®" href="#é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯å®šä¹‰åº”ç”¨å±‚åè®®">é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯ï¼šå®šä¹‰åº”ç”¨å±‚åè®®</a></li>
          </ol>
        </li>
        <li><a id="contents:tcp-åŸç†" href="#tcp-åŸç†">TCP åŸç†</a>
          <ol>
            <li><a id="contents:tcp-å¥—æ¥å­—ä¸­çš„-io-ç¼“å†²" href="#tcp-å¥—æ¥å­—ä¸­çš„-io-ç¼“å†²">TCP å¥—æ¥å­—ä¸­çš„ I/O ç¼“å†²</a></li>
            <li><a id="contents:tcp-å†…éƒ¨å·¥ä½œåŸç†" href="#tcp-å†…éƒ¨å·¥ä½œåŸç†">TCP å†…éƒ¨å·¥ä½œåŸç†</a>
              <ol>
                <li><a id="contents:1-ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥" href="#1-ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥">1 ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥</a></li>
                <li><a id="contents:2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢" href="#2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢">2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</a></li>
                <li><a id="contents:3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢" href="#3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢">3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a id="contents:åŸºäºudpçš„æœåŠ¡ç«¯å®¢æˆ·ç«¯" href="#åŸºäºudpçš„æœåŠ¡ç«¯å®¢æˆ·ç«¯">åŸºäºUDPçš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯</a>
      <ol>
        <li><a id="contents:udpåŸç†" href="#udpåŸç†">UDPåŸç†</a></li>
        <li><a id="contents:udpå·¥ä½œåŸç†" href="#udpå·¥ä½œåŸç†">UDPå·¥ä½œåŸç†</a></li>
        <li><a id="contents:ä»£ç å®ç°" href="#ä»£ç å®ç°">ä»£ç å®ç°</a></li>
        <li><a id="contents:udp-çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨-connect-å‡½æ•°" href="#udp-çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨-connect-å‡½æ•°">UDP çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨ connect å‡½æ•°</a></li>
      </ol>
    </li>
    <li><a id="contents:ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥" href="#ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥">ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥</a>
      <ol>
        <li><a id="contents:åŸºäº-tcp-çš„åŠå…³é—­" href="#åŸºäº-tcp-çš„åŠå…³é—­">åŸºäº TCP çš„åŠå…³é—­</a>
          <ol>
            <li><a id="contents:é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„-shutdown-å‡½æ•°" href="#é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„-shutdown-å‡½æ•°">é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„ shutdown å‡½æ•°</a></li>
            <li><a id="contents:ä¸ºä½•è¦åŠå…³é—­" href="#ä¸ºä½•è¦åŠå…³é—­">ä¸ºä½•è¦åŠå…³é—­</a></li>
            <li><a id="contents:ä¸€ä¸ªä¼˜é›…çš„æµç¨‹" href="#ä¸€ä¸ªä¼˜é›…çš„æµç¨‹">ä¸€ä¸ªä¼˜é›…çš„æµç¨‹</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a id="contents:åŸŸååŠç½‘ç»œåœ°å€" href="#åŸŸååŠç½‘ç»œåœ°å€">åŸŸååŠç½‘ç»œåœ°å€</a>
      <ol>
        <li><a id="contents:åŸŸåç³»ç»Ÿ" href="#åŸŸåç³»ç»Ÿ">åŸŸåç³»ç»Ÿ</a></li>
        <li><a id="contents:ipåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢" href="#ipåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢">IPåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢</a>
          <ol>
            <li><a id="contents:é€šè¿‡åŸŸåè·å¾—ip" href="#é€šè¿‡åŸŸåè·å¾—ip">é€šè¿‡åŸŸåè·å¾—ip</a></li>
            <li><a id="contents:åˆ©ç”¨ipåœ°å€è·å–åŸŸå" href="#åˆ©ç”¨ipåœ°å€è·å–åŸŸå">åˆ©ç”¨IPåœ°å€è·å–åŸŸå</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a id="contents:å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹" href="#å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹">å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹</a>
      <ol>
        <li><a id="contents:å¥—æ¥å­—å¯é€‰é¡¹å’Œ-io-ç¼“å†²å¤§å°" href="#å¥—æ¥å­—å¯é€‰é¡¹å’Œ-io-ç¼“å†²å¤§å°">å¥—æ¥å­—å¯é€‰é¡¹å’Œ I/O ç¼“å†²å¤§å°</a>
          <ol>
            <li><a id="contents:getsockopt--setsockopt" href="#getsockopt--setsockopt">getsockopt &amp; setsockopt</a></li>
            <li><a id="contents:so_sndbuf--so_rcvbuf" href="#so_sndbuf--so_rcvbuf">SO_SNDBUF &amp; SO_RCVBUF</a></li>
          </ol>
        </li>
        <li><a id="contents:so_reuseaddrimportant" href="#so_reuseaddrimportant">SO_REUSEADDRï¼ˆimportantï¼‰</a>
          <ol>
            <li><a id="contents:time-wait-çŠ¶æ€" href="#time-wait-çŠ¶æ€">Time-wait çŠ¶æ€</a></li>
            <li><a id="contents:åœ°å€å†åˆ†é…" href="#åœ°å€å†åˆ†é…">åœ°å€å†åˆ†é…</a></li>
          </ol>
        </li>
        <li><a id="contents:tcp_nodelay" href="#tcp_nodelay">TCP_NODELAY</a>
          <ol>
            <li><a id="contents:ç¦ç”¨-nagle-ç®—æ³•" href="#ç¦ç”¨-nagle-ç®—æ³•">ç¦ç”¨ Nagle ç®—æ³•</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a id="contents:å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯" href="#å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯">å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯</a>
      <ol>
        <li><a id="contents:è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨" href="#è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨">è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨</a>
          <ol>
            <li><a id="contents:ç†è§£è¿›ç¨‹" href="#ç†è§£è¿›ç¨‹">ç†è§£è¿›ç¨‹</a></li>
            <li><a id="contents:è°ƒç”¨-fork-å‡½æ•°åˆ›å»ºè¿›ç¨‹" href="#è°ƒç”¨-fork-å‡½æ•°åˆ›å»ºè¿›ç¨‹">è°ƒç”¨ fork å‡½æ•°åˆ›å»ºè¿›ç¨‹</a></li>
          </ol>
        </li>
        <li><a id="contents:åƒµå°¸è¿›ç¨‹" href="#åƒµå°¸è¿›ç¨‹">åƒµå°¸è¿›ç¨‹</a>
          <ol>
            <li><a id="contents:äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› " href="#äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› ">äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› </a></li>
            <li><a id="contents:é”€æ¯åƒµå°¸è¿›ç¨‹-1åˆ©ç”¨-wait-å‡½æ•°" href="#é”€æ¯åƒµå°¸è¿›ç¨‹-1åˆ©ç”¨-wait-å‡½æ•°">é”€æ¯åƒµå°¸è¿›ç¨‹ 1ï¼šåˆ©ç”¨ wait å‡½æ•°</a></li>
            <li><a id="contents:é”€æ¯åƒµå°¸è¿›ç¨‹-2ä½¿ç”¨-waitpid-å‡½æ•°" href="#é”€æ¯åƒµå°¸è¿›ç¨‹-2ä½¿ç”¨-waitpid-å‡½æ•°">é”€æ¯åƒµå°¸è¿›ç¨‹ 2ï¼šä½¿ç”¨ waitpid å‡½æ•°</a></li>
          </ol>
        </li>
        <li><a id="contents:ä¿¡å·å¤„ç†" href="#ä¿¡å·å¤„ç†">ä¿¡å·å¤„ç†</a>
          <ol>
            <li><a id="contents:ä¿¡å·ä¸-signal-å‡½æ•°" href="#ä¿¡å·ä¸-signal-å‡½æ•°">ä¿¡å·ä¸ signal å‡½æ•°</a></li>
            <li><a id="contents:åˆ©ç”¨-sigaction-å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†" href="#åˆ©ç”¨-sigaction-å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†">åˆ©ç”¨ sigaction å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†</a></li>
            <li><a id="contents:åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹" href="#åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹">åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹</a></li>
          </ol>
        </li>
        <li><a id="contents:åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨" href="#åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨">åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨</a>
          <ol>
            <li><a id="contents:åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹" href="#åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹">åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹</a></li>
            <li><a id="contents:é€šè¿‡-fork-å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦" href="#é€šè¿‡-fork-å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦">é€šè¿‡ fork å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</a></li>
          </ol>
        </li>
        <li><a id="contents:åˆ†å‰²-tcp-çš„-io-ç¨‹åº" href="#åˆ†å‰²-tcp-çš„-io-ç¨‹åº">åˆ†å‰² TCP çš„ I/O ç¨‹åº</a></li>
      </ol>
    </li>
  </ol>
</nav>
    <hr></hr>
</div>


    </div>
    

<main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="justify" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">TCP_IPç½‘ç»œç¼–ç¨‹</h1>

            

            
                
            

            

            <div class="post-body e-content">
                <h2 id="ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—"><a href="#ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—" class="anchor-link">#</a>ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—</h2>
<p>serverï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">clnt_sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">serv_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">clnt_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºå¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç«¯å£å¤ç”¨ï¼Œé˜²æ­¢address in use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">setsockopt</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">one</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// bindåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sockaddr_in</span><span class="p">));</span> 
</span></span><span class="line"><span class="cl">    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span> <span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">))</span><span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¯ä»¥ä¸å®¢æˆ·ç«¯é€šä¿¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">socklen_t</span> <span class="n">clnt_addr_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">clnt_addr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clnt_addr</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸èƒ½ä½¿ç”¨(socklen_t*)clnt_addr_sizeä½¿ç”¨(socklen_t*)&amp;clnt_addr_size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">clnt_sock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clnt_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clnt_addr_size</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">clnt_sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘é€æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">message</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;Hello!&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">write</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>clientï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">serv_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">message</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">str_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºå¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// connectè¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è¯»å–serveræ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">str_len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Message : %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="åœ°å€æ—ä¸æ•°æ®åºåˆ—"><a href="#åœ°å€æ—ä¸æ•°æ®åºåˆ—" class="anchor-link">#</a>åœ°å€æ—ä¸æ•°æ®åºåˆ—</h3>
<p>åªéœ€é€šè¿‡IPåœ°å€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å³å¯åˆ¤æ–­ç½‘ç»œåœ°å€å ç”¨çš„æ€»å­—èŠ‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ ¹æ®IPåœ°å€çš„è¾¹ç•ŒåŒºåˆ†ç½‘ç»œåœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>A ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š0~127</li>
<li>B ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š128~191</li>
<li>C ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š192~223</li>
</ul>
<p>è¿˜æœ‰å¦‚ä¸‹è¿™ç§è¡¨ç¤ºæ–¹å¼ï¼š</p>
<ul>
<li>A ç±»åœ°å€çš„é¦–ä½ä»¥ 0 å¼€å§‹</li>
<li>B ç±»åœ°å€çš„å‰2ä½ä»¥ 10 å¼€å§‹</li>
<li>C ç±»åœ°å€çš„å‰3ä½ä»¥ 110 å¼€å§‹</li>
</ul>
<ol>
<li>ç«¯å£å·ç”± 16 ä½æ„æˆï¼Œå¯åˆ†é…çš„ç«¯å£å·èŒƒå›´é™¤ 0-1023ï¼Œè¿™äº›æ˜¯çŸ¥åç«¯å£ï¼Œä¸€èˆ¬åˆ†é…ç»™ç‰¹å®šçš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥åº”å½“åˆ†é…ç»™æ­¤èŒƒå›´ä¹‹å¤–çš„å€¼ã€‚HTTP çš„ç«¯å£å·æ˜¯ 80 ï¼ŒFTP çš„ç«¯å£å·æ˜¯20å’Œ21
<ol>
<li>è™½ç„¶ç«¯å£å·ä¸èƒ½é‡å¤ï¼Œä½†æ˜¯ TCP å¥—æ¥å­—å’Œ UDP å¥—æ¥å­—ä¸ä¼šå…±ç”¨ç«¯æ¥å£å·ï¼Œæ‰€ä»¥å…è®¸é‡å¤ã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Structure describing an Internet socket address.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">sockaddr_in</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__SOCKADDR_COMMON</span> <span class="p">(</span><span class="n">sin_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">in_port_t</span> <span class="n">sin_port</span><span class="p">;</span>			<span class="cm">/* Port number.  uint16_t  16bits*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>		<span class="cm">/* Internet address.  uint32_t*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Pad to size of `struct sockaddr&#39;.  8 = 16-2-2-4ï¼Œ ç”¨äºå¼ºåˆ¶è½¬æ¢æˆsockaddr*/</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sin_zero</span><span class="p">[</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="p">)</span> <span class="o">-</span> <span class="c1">// 16byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			   <span class="n">__SOCKADDR_COMMON_SIZE</span> <span class="o">-</span>  <span class="c1">// 2byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			   <span class="k">sizeof</span> <span class="p">(</span><span class="n">in_port_t</span><span class="p">)</span> <span class="o">-</span>  <span class="c1">// 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			   <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span><span class="p">)];</span> <span class="c1">// 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><div class="table-container"><table>
  <thead>
      <tr>
          <th>sa_family_t</th>
          <th>åœ°å€æ—ï¼ˆaddress familyï¼‰</th>
          <th>sys/socket.h</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>socklen_t</td>
          <td>é•¿åº¦ï¼ˆlength of structï¼‰</td>
          <td>sys/socket.h</td>
      </tr>
      <tr>
          <td>in_addr_t</td>
          <td>IPåœ°å€ï¼Œå£°æ˜ä¸º uint_32_t</td>
          <td>netinet/in.h</td>
      </tr>
      <tr>
          <td>in_port_t</td>
          <td>ç«¯å£å·ï¼Œå£°æ˜ä¸º uint_16_t</td>
          <td>netinet/in.h</td>
      </tr>
      <tr>
          <td>int 8_t è¿™ç§ç±»å‹éƒ½æ˜¯åœ¨è¯¥å¤´æ–‡ä»¶</td>
          <td>signed 8-bit int</td>
          <td>sys/types.h</td>
      </tr>
  </tbody>
</table></div>
<ul>
<li>
<p>å¤§ç«¯åºï¼ˆBig Endianï¼‰ï¼šé«˜ä½å­—èŠ‚å­˜æ”¾åˆ°ä½ä½åœ°å€ï¼Œç½‘ç»œå­—èŠ‚åº</p>
</li>
<li>
<p>å°ç«¯åºï¼ˆLittle Endianï¼‰ï¼šé«˜ä½å­—èŠ‚å­˜æ”¾åˆ°é«˜ä½åœ°å€</p>
</li>
<li>
<p>h to n s çš„ h ä»£è¡¨ä¸»æœºï¼ˆhostï¼‰å­—èŠ‚åºã€‚é€šå¸¸å°ç«¯åº</p>
</li>
<li>
<p>htons çš„ n ä»£è¡¨ç½‘ç»œï¼ˆnetworkï¼‰å­—èŠ‚åºã€‚</p>
</li>
<li>
<p>s ä»£è¡¨ä¸¤ä¸ªå­—èŠ‚çš„ short =uint16=2å­—èŠ‚ï¼Œå› æ­¤ä»¥ s ä¸ºåç¼€çš„å‡½æ•°ç”¨äºç«¯å£è½¬æ¢</p>
</li>
<li>
<p>l ä»£è¡¨å››ä¸ªå­—èŠ‚çš„ long ç±»å‹ï¼Œæ‰€ä»¥ä»¥ l ä¸ºåç¼€çš„å‡½æ•°ç”¨äº IP åœ°å€è½¬æ¢ï¼ˆlongåœ¨64ä½ç³»ç»Ÿä¸‹ä»æ˜¯4å­—èŠ‚ï¼Œå› ä¸ºæ˜¯uint32ï¼‰</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">in_addr_t</span> <span class="nf">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">);</span>   <span class="c1">// ç‚¹/æ•°å­—ç¬¦ä¸²å½¢å¼çš„IPåœ°å€è½¬æ¢æˆæ•´æ•°å‹çš„IPåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1">//æˆåŠŸæ—¶è¿”å› 32 ä½å¤§ç«¯åºæ•´æ•°å‹å€¼ï¼Œå¤±è´¥æ—¶è¿”å› INADDR_NONEï¼Œä»¥ä¾¿å­˜å…¥æ˜¯sockaddr_inä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">inet_aton</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>  <span class="c1">// more use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› 1 ï¼Œå¤±è´¥æ—¶è¿”å› 0
</span></span></span><span class="line"><span class="cl"><span class="cm">string: å«æœ‰éœ€è¦è½¬æ¢çš„IPåœ°å€ä¿¡æ¯çš„å­—ç¬¦ä¸²åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">addr: ä¿å­˜è½¬æ¢ç»“æœçš„ in_addr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">inet_ntoa</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">adr</span><span class="p">);</span>  <span class="c1">// ç½‘ç»œå­—èŠ‚åºæ•´æ•°å‹IPåœ°å€è½¬æ¢æˆå­—ç¬¦ä¸²å½¢å¼
</span></span></span><span class="line"><span class="cl"><span class="c1">//æˆåŠŸæ—¶è¿”å›ä¿å­˜è½¬æ¢ç»“æœçš„å­—ç¬¦ä¸²åœ°å€å€¼ï¼Œå¤±è´¥æ—¶è¿”å› NULL ç©ºæŒ‡é’ˆ
</span></span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="anchor-link">#</a>é—®é¢˜</h3>
<ol>
<li>ç«¯å£ä¸ä¸€è‡´ä¼šå¯¼è‡´ä¹±ç 
<ol>
<li>htonl(8888) != htons(8888)ï¼Œ<a href="https://www.cnblogs.com/sddai/p/5790479.html" target="_blank" rel="noopener">htons</a></li>
</ol>
</li>
<li><a href="https://blog.csdn.net/qq_45831156/article/details/107469716" target="_blank" rel="noopener">Linux æ–‡ä»¶ 1.4â€”æ–‡ä»¶æè¿°ç¬¦0 1 2ï¼ˆæ–‡ä»¶æ“ä½œç®€è¿°ï¼‰</a>
<ol>
<li>å› æ­¤æ–‡ä»¶openä¹‹åçš„æ–‡ä»¶æè¿°ç¬¦ä»3å¼€å§‹</li>
</ol>
</li>
</ol>
<p><a href="https://blog.csdn.net/owen7500/article/details/53263981" target="_blank" rel="noopener">åº•å±‚æ–‡ä»¶I/Oå’ŒANSIæ ‡å‡†I/Oçš„åŒºåˆ«</a> é€šè¿‡æ–‡ä»¶I/Oè¯»å†™æ–‡ä»¶æ—¶ï¼Œæ¯æ¬¡æ“ä½œéƒ½ä¼šæ‰§è¡Œç›¸å…³ç³»ç»Ÿè°ƒç”¨ã€‚è¿™æ ·å¤„ç†çš„å¥½å¤„æ˜¯ç›´æ¥è¯»å†™å®é™…æ–‡ä»¶ï¼Œåå¤„æ˜¯é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œæ ‡å‡†I/Oå¯ä»¥çœ‹æˆæ˜¯åœ¨æ–‡ä»¶I/Oçš„åŸºç¡€ä¸Šå°è£…äº†ç¼“å†²æœºåˆ¶ã€‚å…ˆè¯»å†™ç¼“å†²åŒºï¼Œå¿…è¦æ—¶å†è®¿é—®å®é™…æ–‡ä»¶ï¼Œä»è€Œå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ã€‚</p>
<h2 id="åŸºäºtcpçš„å®¢æˆ·ç«¯æœåŠ¡ç«¯"><a href="#åŸºäºtcpçš„å®¢æˆ·ç«¯æœåŠ¡ç«¯" class="anchor-link">#</a>åŸºäºTCPçš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯</h2>
<h3 id="tcpip-åè®®æ ˆ"><a href="#tcpip-åè®®æ ˆ" class="anchor-link">#</a>TCP/IP åè®®æ ˆ</h3>
<p>TCP/IP åè®®æ ˆå…±åˆ†ä¸º 4 å±‚ï¼Œå¯ä»¥ç†è§£ä¸ºæ•°æ®æ”¶å‘åˆ†æˆäº† 4 ä¸ªå±‚æ¬¡åŒ–è¿‡ç¨‹ï¼Œé€šè¿‡å±‚æ¬¡åŒ–çš„æ–¹å¼æ¥è§£å†³é—®é¢˜</p>
<ol>
<li>é“¾è·¯å±‚</li>
</ol>
<p>é“¾è·¯å±‚æ˜¯<strong>ç‰©ç†é“¾æ¥é¢†åŸŸæ ‡å‡†åŒ–</strong>çš„ç»“æœï¼Œä¹Ÿæ˜¯æœ€åŸºæœ¬çš„é¢†åŸŸï¼Œä¸“é—¨å®šä¹‰LANã€WANã€MANç­‰ç½‘ç»œæ ‡å‡†ã€‚è‹¥ä¸¤å°ä¸»æœºé€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®äº¤æ¢ï¼Œåˆ™éœ€è¦ç‰©ç†è¿æ¥ï¼Œé“¾è·¯å±‚å°±è´Ÿè´£è¿™äº›æ ‡å‡†ã€‚</p>
<ol start="2">
<li>IP å±‚</li>
</ol>
<p>å‡†å¤‡å¥½ç‰©ç†è¿æ¥åå°±è¦ä¼ è¾“æ•°æ®ã€‚ä¸ºäº†åœ¨å¤æ‚ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼Œé¦–å…ˆè¦<strong>è€ƒè™‘è·¯å¾„çš„é€‰æ‹©</strong>ã€‚å‘ç›®æ ‡ä¼ è¾“æ•°æ®éœ€è¦ç»è¿‡å“ªæ¡è·¯å¾„ï¼Ÿè§£å†³æ­¤é—®é¢˜çš„å°±æ˜¯IPå±‚ï¼Œè¯¥å±‚ä½¿ç”¨çš„åè®®å°±æ˜¯IPã€‚<br />IP æ˜¯<strong>é¢å‘æ¶ˆæ¯çš„ã€ä¸å¯é </strong>çš„åè®®ã€‚æ¯æ¬¡ä¼ è¾“æ•°æ®æ—¶ä¼šå¸®æˆ‘ä»¬é€‰æ‹©è·¯å¾„ï¼Œä½†å¹¶ä¸ä¸€è‡´ã€‚å¦‚æœä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œåˆ™é€‰æ‹©å…¶ä»–è·¯å¾„ï¼Œä½†æ˜¯å¦‚æœå‘ç”Ÿæ•°æ®ä¸¢å¤±æˆ–é”™è¯¯ï¼Œåˆ™æ— æ³•è§£å†³ã€‚æ¢è¨€ä¹‹ï¼ŒIPåè®®æ— æ³•åº”å¯¹æ•°æ®é”™è¯¯ã€‚</p>
<ol start="3">
<li>TCP/UDP å±‚</li>
</ol>
<p>IP å±‚è§£å†³æ•°æ®ä¼ è¾“ä¸­çš„è·¯å¾„é€‰æ‹©é—®é¢˜ï¼Œåªéœ€ç…§æ­¤è·¯å¾„ä¼ è¾“æ•°æ®å³å¯ã€‚TCP å’Œ UDP å±‚ä»¥ IP å±‚æä¾›çš„è·¯å¾„ä¿¡æ¯ä¸ºåŸºç¡€å®Œæˆ<strong>å®é™…çš„æ•°æ®ä¼ è¾“</strong>ï¼Œæ•…è¯¥å±‚åˆç§°ä¸ºä¼ è¾“å±‚ ã€‚ TCP å¯ä»¥ä¿è¯æ•°æ®çš„å¯é ä¼ è¾“ï¼Œä½†æ˜¯å®ƒå‘é€æ•°æ®æ—¶ä»¥ IP å±‚ä¸ºåŸºç¡€ï¼ˆè¿™ä¹Ÿæ˜¯åè®®æ ˆå±‚æ¬¡åŒ–çš„åŸå› ï¼‰ã€‚<br />IP å±‚åªå…³æ³¨<strong>ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆæ•°æ®ä¼ è¾“åŸºæœ¬å•ä½ï¼‰çš„ä¼ è¾“è¿‡ç¨‹</strong>ã€‚å› æ­¤ï¼Œå³ä½¿ä¼ è¾“å¤šä¸ªæ•°æ®åŒ…ï¼Œæ¯ä¸ªæ•°æ®åŒ…ä¹Ÿæ˜¯ç”± IP å±‚å®é™…ä¼ è¾“çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ è¾“é¡ºåºåŠä¼ è¾“æœ¬èº«æ˜¯ä¸å¯é çš„ã€‚è‹¥åªåˆ©ç”¨IPå±‚ä¼ è¾“æ•°æ®ï¼Œæ˜¯ä¸å¯é çš„ï¼Œéœ€è¦åˆ©ç”¨TCPæ¥è§£å†³æ•°æ®ä¸¢å¤±ï¼Œé¡ºåºä¸ä¸€è‡´ç­‰é—®é¢˜ã€‚</p>
<ol start="4">
<li>åº”ç”¨å±‚</li>
</ol>
<p>ä¸Šè¿°å†…å®¹æ˜¯å¥—æ¥å­—é€šä¿¡è¿‡ç¨‹ä¸­è‡ªåŠ¨å¤„ç†çš„ã€‚é€‰æ‹©æ•°æ®ä¼ è¾“è·¯å¾„ã€æ•°æ®ç¡®è®¤è¿‡ç¨‹éƒ½è¢«<strong>éšè—åˆ°å¥—æ¥å­—å†…éƒ¨</strong>ã€‚å‘ç¨‹åºå‘˜æä¾›çš„å·¥å…·å°±æ˜¯å¥—æ¥å­—ï¼Œåªéœ€è¦åˆ©ç”¨å¥—æ¥å­—ç¼–å‡ºç¨‹åºå³å¯ã€‚ç¼–å†™è½¯ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ ¹æ®ç¨‹åºçš„ç‰¹ç‚¹æ¥<strong>å†³å®šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ä¼ è¾“è§„åˆ™</strong>ï¼Œè¿™ä¾¿æ˜¯åº”ç”¨å±‚åè®®ã€‚</p>
<h3 id="tcpæµç¨‹"><a href="#tcpæµç¨‹" class="anchor-link">#</a>TCPæµç¨‹</h3>
<h4 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="anchor-link">#</a>æœåŠ¡ç«¯</h4>
<p>#include &lt;sys/socket.h&gt;</p>
<ol>
<li>
<p>socket(AF_INET, SOCKEt_STREAM, 0) åˆ›å»ºå¥—æ¥å­—</p>
</li>
<li>
<p>bind(sockfd, (struct sockaddr *)&amp;serv_adr, sizeof(serv_adr)) åˆ†é…å¥—æ¥å­—åœ°å€</p>
</li>
<li>
<p>listen(sockfd, è¯·æ±‚æ•°backlog) ç­‰å¾…è¿æ¥è¯·æ±‚çŠ¶æ€ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯æ‰èƒ½å‘é€connetè¯·æ±‚</p>
</li>
<li>
<p>accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen) å…è®¸è¿æ¥ï¼Œäº§ç”Ÿç”¨äºæ•°æ®IOçš„å¥—æ¥å­—ï¼Œéœ€è¦close()</p>
</li>
<li>
<p>read() / write() æ•°æ®äº¤æ¢</p>
</li>
<li>
<p>close() æ–­å¼€è¿æ¥</p>
</li>
<li>
<p>æœåŠ¡ç«¯å®ç°è¿‡ç¨‹ä¸­é¦–å…ˆè¦åˆ›å»ºå¥—æ¥å­—ï¼Œæ­¤æ—¶çš„å¥—æ¥å­—å¹¶éæ˜¯çœŸæ­£çš„æœåŠ¡ç«¯å¥—æ¥å­—</p>
</li>
<li>
<p>ä¸ºäº†å®Œæˆå¥—æ¥å­—åœ°å€çš„åˆ†é…ï¼Œåˆå§‹åŒ–ç»“æ„ä½“å˜é‡å¹¶è°ƒç”¨ bind å‡½æ•°ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ listen å‡½æ•°è¿›å…¥ç­‰å¾…è¿æ¥è¯·æ±‚çŠ¶æ€ã€‚è¿æ¥è¯·æ±‚çŠ¶æ€é˜Ÿåˆ—çš„é•¿åº¦è®¾ç½®ä¸º5.æ­¤æ—¶çš„å¥—æ¥å­—æ‰æ˜¯æœåŠ¡ç«¯å¥—æ¥å­—ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ accept å‡½æ•°ä»é˜Ÿå¤´å– 1 ä¸ªè¿æ¥è¯·æ±‚ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œå¹¶è¿”å›åˆ›å»ºçš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚å¦å¤–ï¼Œè°ƒç”¨ accept å‡½æ•°æ—¶è‹¥ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ <strong>accept å‡½æ•°ä¸ä¼šè¿”å›</strong>ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­å‡ºç°æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ write å‡½æ•°å‘å®¢æˆ·ç«¯ä¼ é€æ•°æ®ï¼Œè°ƒç”¨ close å…³é—­è¿æ¥</p>
</li>
</ol>
<h4 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="anchor-link">#</a>å®¢æˆ·ç«¯</h4>
<ol>
<li>åˆ›å»ºå‡†å¤‡è¿æ¥æœåŠ¡å™¨çš„å¥—æ¥å­—ï¼Œæ­¤æ—¶åˆ›å»ºçš„æ˜¯ TCP å¥—æ¥å­—</li>
<li>ç»“æ„ä½“å˜é‡ serv_addr ä¸­åˆå§‹åŒ–IPå’Œç«¯å£ä¿¡æ¯ã€‚åˆå§‹åŒ–å€¼ä¸º<strong>ç›®æ ‡æœåŠ¡å™¨ç«¯å¥—æ¥å­—</strong>çš„IPå’Œç«¯å£ä¿¡æ¯ã€‚</li>
<li>è°ƒç”¨ connect å‡½æ•°å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œè‡ªåŠ¨åˆ†é…å®¢æˆ·ç«¯IPåœ°å€å’Œç«¯å£</li>
<li>å®Œæˆè¿æ¥åï¼Œæ¥æ”¶æœåŠ¡ç«¯ä¼ è¾“çš„æ•°æ®</li>
<li>æ¥æ”¶æ•°æ®åè°ƒç”¨ close å‡½æ•°å…³é—­å¥—æ¥å­—ï¼Œç»“æŸä¸æœåŠ¡å™¨ç«¯çš„è¿æ¥ã€‚(å¯¹å¥—æ¥å­—è°ƒç”¨closeå‡½æ•°ï¼Œå¯¹åº”äºå‘å»ºç«‹è¿æ¥çš„å¯¹åº”å¥—æ¥å­—å‘é€EOFã€‚å³ï¼Œå¦‚æœå®¢æˆ·ç«¯çš„å¥—æ¥å­—è°ƒç”¨äº†closeå‡½æ•°ï¼ŒæœåŠ¡ç«¯<strong>readæ—¶å€™ä¼šè¿”å›0</strong>ã€‚)</li>
</ol>
<ul>
<li>å®¢æˆ·ç«¯åªèƒ½ç­‰åˆ°æœåŠ¡ç«¯è°ƒç”¨ listen å‡½æ•°åæ‰èƒ½è°ƒç”¨ connect å‡½æ•°</li>
<li>æœåŠ¡å™¨ç«¯å¯èƒ½ä¼šåœ¨å®¢æˆ·ç«¯è°ƒç”¨ connect ä¹‹å‰è°ƒç”¨ accept å‡½æ•°ï¼Œè¿™æ—¶æœåŠ¡å™¨ç«¯è¿›å…¥<strong>é˜»å¡ï¼ˆblockingï¼‰çŠ¶æ€</strong>ï¼Œç›´åˆ°å®¢æˆ·ç«¯è°ƒç”¨ connect å‡½æ•°åæ¥æ”¶åˆ°è¿æ¥è¯·æ±‚ã€‚</li>
</ul>
<h4 id="echo-serverclient"><a href="#echo-serverclient" class="anchor-link">#</a>echo server/client</h4>
<p>ä½¿ç”¨forå¾ªç¯å¤„ç†å¤šä¸ªè¿æ¥ï¼Œä¼šå‡ºç°æœåŠ¡ç«¯å‘é€å¤šä¸ªæ•°æ®ç»™ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å¯èƒ½æ•°æ®å¤ªå¤šï¼Œéœ€è¦åˆ†å¼€å‘é€ï¼Œä½†å®¢æˆ·ç«¯åªè°ƒç”¨ä¸€æ¬¡readã€‚ä¸Šè¿°åŸå› ä¸ºTCP ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œã€‚</p>
<h3 id="é—®é¢˜-1"><a href="#é—®é¢˜-1" class="anchor-link">#</a>é—®é¢˜</h3>
<p>åˆ†å±‚çš„å¥½å¤„ï¼šâ‘ éš”å±‚ä¹‹é—´æ˜¯ç‹¬ç«‹çš„â‘¡çµæ´»æ€§å¥½â‘¢ç»“æ„ä¸Šå¯ä»¥åˆ†éš”å¼€â‘£æ˜“äºå®ç°å’Œç»´æŠ¤â‘¤èƒ½ä¿ƒè¿›æ ‡å‡†åŒ–å·¥ä½œã€‚</p>
<h2 id="åŸºäº-tcp-çš„æœåŠ¡ç«¯å®¢æˆ·ç«¯2"><a href="#åŸºäº-tcp-çš„æœåŠ¡ç«¯å®¢æˆ·ç«¯2" class="anchor-link">#</a>åŸºäº TCP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼ˆ2ï¼‰</h2>
<h3 id="echo-clientçš„å®Œç¾å®ç°"><a href="#echo-clientçš„å®Œç¾å®ç°" class="anchor-link">#</a>echo clientçš„å®Œç¾å®ç°</h3>
<h4 id="å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°"><a href="#å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°" class="anchor-link">#</a>å·²çŸ¥æ¥æ”¶æ•°æ®çš„å¤§å°</h4>
<p>echo clientå¦‚æœå¯ä»¥çŸ¥é“æ¥æ”¶æ•°æ®çš„å¤§å°ï¼Œåˆ™å¯ä»¥åˆ©ç”¨forå¾ªç¯æ¥æ¥æ”¶ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ä¸ç¡®å®šã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">str_len</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">recv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">recv_len</span> <span class="o">&lt;</span> <span class="n">str_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_cnt</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">recv_len</span><span class="p">],</span> <span class="n">BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">recv_cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">error_handling</span><span class="p">(</span><span class="s">&#34;read() error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_len</span> <span class="o">+=</span> <span class="n">recv_cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯å®šä¹‰åº”ç”¨å±‚åè®®"><a href="#é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯å®šä¹‰åº”ç”¨å±‚åè®®" class="anchor-link">#</a>é—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯ï¼šå®šä¹‰åº”ç”¨å±‚åè®®</h4>
<p>åœ¨æ”¶å‘è¿‡ç¨‹ä¸­å®šå¥½è§„åˆ™ï¼ˆåè®®ï¼‰ä»¥è¡¨ç¤ºæ•°æ®è¾¹ç•Œï¼Œæˆ–è€…æå‰å‘ŠçŸ¥éœ€è¦å‘é€çš„æ•°æ®çš„å¤§å°ã€‚æœåŠ¡ç«¯/å®¢æˆ·ç«¯å®ç°è¿‡ç¨‹ä¸­é€æ­¥å®šä¹‰çš„è§„åˆ™é›†åˆå°±æ˜¯åº”ç”¨å±‚åè®®ã€‚</p>
<h3 id="tcp-åŸç†"><a href="#tcp-åŸç†" class="anchor-link">#</a>TCP åŸç†</h3>
<h4 id="tcp-å¥—æ¥å­—ä¸­çš„-io-ç¼“å†²"><a href="#tcp-å¥—æ¥å­—ä¸­çš„-io-ç¼“å†²" class="anchor-link">#</a>TCP å¥—æ¥å­—ä¸­çš„ I/O ç¼“å†²</h4>
<p>å®é™…ä¸Šï¼Œwrite å‡½æ•°è°ƒç”¨åå¹¶éç«‹å³ä¼ è¾“æ•°æ®ï¼Œ read å‡½æ•°è°ƒç”¨åä¹Ÿå¹¶éé©¬ä¸Šæ¥æ”¶æ•°æ®ã€‚<br /><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100.png?imageMogr2/format/webp%7C" alt="image"><br />I/O ç¼“å†²ç‰¹æ€§å¯ä»¥æ•´ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>I/O ç¼“å†²åœ¨æ¯ä¸ª TCP å¥—æ¥å­—ä¸­å•ç‹¬å­˜åœ¨</li>
<li>I/O ç¼“å†²åœ¨åˆ›å»ºå¥—æ¥å­—æ—¶è‡ªåŠ¨ç”Ÿæˆ</li>
<li>å³ä½¿å…³é—­å¥—æ¥å­—ä¹Ÿä¼šç»§ç»­ä¼ é€’è¾“å‡ºç¼“å†²ä¸­é—ç•™çš„æ•°æ®</li>
<li>å…³é—­å¥—æ¥å­—å°†ä¸¢å¤±è¾“å…¥ç¼“å†²ä¸­çš„æ•°æ®</li>
</ul>
<h4 id="tcp-å†…éƒ¨å·¥ä½œåŸç†"><a href="#tcp-å†…éƒ¨å·¥ä½œåŸç†" class="anchor-link">#</a>TCP å†…éƒ¨å·¥ä½œåŸç†</h4>
<p>TCP å¥—æ¥å­—ä»åˆ›å»ºåˆ°æ¶ˆå¤±æ‰€ç»è¿‡çš„è¿‡ç¨‹åˆ†ä¸ºå¦‚ä¸‹ä¸‰æ­¥ï¼š</p>
<ul>
<li>ä¸å¯¹æ–¹å¥—æ¥å­—å»ºç«‹è¿æ¥</li>
<li>ä¸å¯¹æ–¹å¥—æ¥å­—è¿›è¡Œæ•°æ®äº¤æ¢</li>
<li>æ–­å¼€ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥</li>
</ul>
<h5 id="1-ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥"><a href="#1-ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥" class="anchor-link">#</a>1 ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥</h5>
<ul>
<li><strong>Three-way handshaking</strong></li>
<li><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-1.png?imageMogr2/format/webp%7C" alt="image">
<ul>
<li>ç¬¬ä¸€æ¬¡å®¢æˆ·ç«¯å‘é€SYNï¼Œè¡¨ç¤ºå‘é€SEQä¸º1000çš„æ•°æ®åŒ…</li>
<li>ç¬¬äºŒæ¬¡æœåŠ¡ç«¯å‘é€SYN+ACKï¼Œè¡¨ç¤ºæ¥æ”¶åå‘é€ACKï¼ˆ1000+1ï¼‰çš„æ•°æ®åŒ…ï¼Œå¹¶å‘é€SEQä¸º2000çš„æ•°æ®åŒ…</li>
<li>ç¬¬ä¸‰æ¬¡å®¢æˆ·ç«¯å‘é€SYN+ACKï¼Œè¡¨ç¤ºæ¥æ”¶åˆ°æœåŠ¡ç«¯çš„æ•°æ®åŒ…ï¼Œå¹¶å‘é€ä¸‹ä¸€ä¸ªæ•°æ®åŒ…</li>
</ul>
</li>
</ul>
<h5 id="2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢"><a href="#2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢" class="anchor-link">#</a>2ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</h5>
<ul>
<li><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-2.png?imageMogr2/format/webp%7C" alt="image">
<ul>
<li>é¦–å…ˆä¸»æœºAå‘é€100å­—èŠ‚çš„æ•°æ®åŒ…ï¼ŒSEQä¸º1200ï¼Œä¸»æœºBç¡®è®¤æ”¶åˆ°å‘é€ACKï¼ˆSEQ+ä¼ é€’å­—èŠ‚æ•°+1ï¼‰=1301ç»™ä¸»æœºBï¼Œé˜²æ­¢ä¸¢å¤±æ•°æ®</li>
<li>ç¬¬äºŒæ¬¡å‘é€æ—¶ä¸»æœºAå¤±è´¥ï¼Œä¸»æœºBæœªå‘é€ACKï¼Œä¸»æœºAå¯åŠ¨è®¡æ—¶å™¨ç­‰å¾…ACKåº”ç­”ï¼Œè¶…æ—¶åˆ™é‡ä¼ æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<h5 id="3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢"><a href="#3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢" class="anchor-link">#</a>3ä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</h5>
<p><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-3.png?imageMogr2/format/webp%7C" alt="image"><br />å›¾ä¸­æ•°æ®åŒ…å†…çš„ FIN è¡¨ç¤ºæ–­å¼€è¿æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒæ–¹å„å‘é€ 1 æ¬¡ FIN æ¶ˆæ¯åæ–­å¼€è¿æ¥ã€‚å›¾ä¸­ï¼Œä¸»æœº A ä¼ é€’äº†ä¸¤æ¬¡ ACK 5001ï¼Œä¹Ÿè®¸è¿™é‡Œä¼šæœ‰å›°æƒ‘ã€‚å…¶å®ï¼Œç¬¬äºŒæ¬¡ FIN æ•°æ®åŒ…ä¸­çš„ ACK 5001 åªæ˜¯å› ä¸ºå‘é€äº† ACK æ¶ˆæ¯åæœªæ¥æ”¶åˆ°çš„æ•°æ®é‡ä¼ çš„ã€‚</p>
<h2 id="åŸºäºudpçš„æœåŠ¡ç«¯å®¢æˆ·ç«¯"><a href="#åŸºäºudpçš„æœåŠ¡ç«¯å®¢æˆ·ç«¯" class="anchor-link">#</a>åŸºäºUDPçš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯</h2>
<h3 id="udpåŸç†"><a href="#udpåŸç†" class="anchor-link">#</a>UDPåŸç†</h3>
<p>å¯„ä¿¡å‰åº”å…ˆåœ¨ä¿¡å°ä¸Šå¡«å¥½å¯„ä¿¡äººipå’Œæ”¶ä¿¡äººçš„åœ°å€portï¼Œä¹‹åè´´ä¸Šé‚®ç¥¨æ”¾è¿›é‚®ç­’writeå³å¯ã€‚å½“ç„¶ï¼Œä¿¡ä»¶çš„ç‰¹ç‚¹ä½¿æˆ‘ä»¬æ— æ³•ç¡®è®¤ä¿¡ä»¶æ˜¯å¦è¢«æ”¶åˆ°ã€‚é‚®å¯„è¿‡ç¨‹ä¸­ä¹Ÿå¯èƒ½å‘ç”Ÿä¿¡ä»¶ä¸¢å¤±çš„æƒ…å†µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¿¡ä»¶æ˜¯ä¸€ç§ä¸å¯é çš„ä¼ è¾“æ–¹å¼ï¼ŒUDP ä¹Ÿæ˜¯ä¸€ç§ä¸å¯é çš„æ•°æ®ä¼ è¾“æ–¹å¼ã€‚</p>
<h3 id="udpå·¥ä½œåŸç†"><a href="#udpå·¥ä½œåŸç†" class="anchor-link">#</a>UDPå·¥ä½œåŸç†</h3>
<p><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-4.png?imageMogr2/format/webp%7C" alt="image"><br />IP çš„ä½œç”¨å°±æ˜¯è®©ç¦»å¼€ä¸»æœº B çš„ UDP æ•°æ®åŒ…å‡†ç¡®ä¼ é€’åˆ°ä¸»æœº A ã€‚ä½†æ˜¯æŠŠ UDP æ•°æ®åŒ…æœ€ç»ˆäº¤ç»™ä¸»æœº A çš„æŸä¸€ UDP å¥—æ¥å­—çš„è¿‡ç¨‹æ˜¯ç”± UDP å®Œæˆçš„ã€‚UDP çš„æœ€é‡è¦çš„ä½œç”¨å°±æ˜¯æ ¹æ®ç«¯å£å·å°†ä¼ åˆ°ä¸»æœºçš„æ•°æ®åŒ…äº¤ä»˜ç»™æœ€ç»ˆçš„ UDP å¥—æ¥å­—ã€‚<br />TCP æ¯” UDP æ…¢çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li>æ”¶å‘æ•°æ®å‰åè¿›è¡Œçš„è¿æ¥è®¾ç½®åŠæ¸…é™¤è¿‡ç¨‹ã€‚</li>
<li>æ”¶å‘è¿‡ç¨‹ä¸­ä¸ºä¿è¯å¯é æ€§è€Œæ·»åŠ çš„æµæ§åˆ¶ã€‚</li>
</ul>
<p>å¦‚æœæ”¶å‘çš„æ•°æ®é‡å°ä½†æ˜¯éœ€è¦é¢‘ç¹è¿æ¥æ—¶ï¼ŒUDP æ¯” TCP æ›´é«˜æ•ˆã€‚</p>
<ul>
<li>TCPéœ€è¦listenã€acceptï¼Œè€ŒUDPåªéœ€è¦åªæœ‰åˆ›å»ºå¥—æ¥å­—å’Œæ•°æ®äº¤æ¢è¿‡ç¨‹ã€‚</li>
<li>TCPåªèƒ½ä¸€ä¸€å¯¹åº”æœåŠ¡ç«¯å®¢æˆ·ç«¯ï¼ŒUDPå¯ä»¥ä¸€å¯¹å¤šä¼ è¾“</li>
</ul>
<h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="anchor-link">#</a>ä»£ç å®ç°</h3>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">ssize_t</span> <span class="nf">sendto</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å›å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">sock: ç”¨äºä¼ è¾“æ•°æ®çš„ UDP å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="cm">buff: ä¿å­˜å¾…ä¼ è¾“æ•°æ®çš„ç¼“å†²åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">nbytes: å¾…ä¼ è¾“çš„æ•°æ®é•¿åº¦ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½
</span></span></span><span class="line"><span class="cl"><span class="cm">flags: å¯é€‰é¡¹å‚æ•°ï¼Œè‹¥æ²¡æœ‰åˆ™ä¼ é€’ 0
</span></span></span><span class="line"><span class="cl"><span class="cm">to: å­˜æœ‰ç›®æ ‡åœ°å€çš„ sockaddr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">addrlen: ä¼ é€’ç»™å‚æ•° to çš„åœ°å€å€¼ç»“æ„ä½“å˜é‡é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="cm">è°ƒç”¨ sendto å‡½æ•°æ—¶è‡ªåŠ¨ç»™clientåˆ†é…IPå’Œç«¯å£å·
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">ssize_t</span> <span class="nf">recvfrom</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">sock: ç”¨äºä¼ è¾“æ•°æ®çš„ UDP å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="cm">buff: ä¿å­˜å¾…ä¼ è¾“æ•°æ®çš„ç¼“å†²åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">nbytes: å¾…ä¼ è¾“çš„æ•°æ®é•¿åº¦ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½
</span></span></span><span class="line"><span class="cl"><span class="cm">flags: å¯é€‰é¡¹å‚æ•°ï¼Œè‹¥æ²¡æœ‰åˆ™ä¼ é€’ 0
</span></span></span><span class="line"><span class="cl"><span class="cm">from: å­˜æœ‰**å‘é€ç«¯**åœ°å€ä¿¡æ¯çš„ sockaddr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">addrlen: ä¿å­˜å‚æ•° from çš„ç»“æ„ä½“å˜é‡é•¿åº¦çš„å˜é‡åœ°å€å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="udp-çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨-connect-å‡½æ•°"><a href="#udp-çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨-connect-å‡½æ•°" class="anchor-link">#</a>UDP çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨ connect å‡½æ•°</h3>
<ul>
<li>è¾“å…¥å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°å’Œè¾“å‡ºå‡½æ•°çš„è°ƒç”¨æ¬¡æ•°åº”è¯¥<strong>å®Œå…¨ä¸€è‡´</strong></li>
<li>æ¯æ¬¡è°ƒç”¨ sendto å‡½æ•°æ—¶æ¯æ¬¡éƒ½å˜æ›´ç›®æ ‡åœ°å€ï¼Œå› æ­¤å¯ä»¥é‡å¤åˆ©ç”¨åŒä¸€ UDP å¥—æ¥å­—å‘ä¸åŒç›®æ ‡ä¼ é€’æ•°æ®ã€‚è¿™ç§æœªæ³¨å†Œç›®æ ‡åœ°å€ä¿¡æ¯çš„å¥—æ¥å­—ç§°ä¸ºæœªè¿æ¥å¥—æ¥å­—ï¼Œåä¹‹ï¼Œæ³¨å†Œäº†ç›®æ ‡åœ°å€çš„å¥—æ¥å­—ç§°ä¸ºè¿æ¥ connected å¥—æ¥å­—ã€‚
<ul>
<li>sendtoæµç¨‹</li>
<li>ç¬¬ 1 é˜¶æ®µï¼šå‘ UDP å¥—æ¥å­—æ³¨å†Œç›®æ ‡ IP å’Œç«¯å£å·</li>
<li>ç¬¬ 2 é˜¶æ®µï¼šä¼ è¾“æ•°æ®</li>
<li>ç¬¬ 3 é˜¶æ®µï¼šåˆ é™¤ UDP å¥—æ¥å­—ä¸­æ³¨å†Œçš„ç›®æ ‡åœ°å€ä¿¡æ¯ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>python -c &quot;import socket;print([(s.connect(('8.8.8.8', 53)), s.getsockname()[0], s.close()) for s in [socket.socket(socket.AF_INET, socket.SOCK_DGRAM)]][0][1])&quot;</p>
</blockquote>
<p>ç»ˆç«¯è¾“å…¥ä¸Šè¿°å‘½ä»¤è·å–æœ¬åœ°ip</p>
<h2 id="ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥"><a href="#ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥" class="anchor-link">#</a>ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥</h2>
<h3 id="åŸºäº-tcp-çš„åŠå…³é—­"><a href="#åŸºäº-tcp-çš„åŠå…³é—­" class="anchor-link">#</a>åŸºäº TCP çš„åŠå…³é—­</h3>
<p>TCP çš„æ–­å¼€è¿‡ç¨‹å¯èƒ½å‘ç”Ÿé¢„æƒ³ä¸åˆ°çš„æƒ…å†µï¼Œéœ€è¦æŒæ¡åŠå…³é—­ï¼ˆhalf-closeï¼‰ã€‚Linux å’Œ Windows çš„ closesocket å‡½æ•°æ„å‘³ç€å®Œå…¨æ–­å¼€è¿æ¥ã€‚å®Œå…¨æ–­å¼€ä¸ä»…æŒ‡æ— æ³•ä¼ è¾“æ•°æ®ï¼Œè€Œä¸”ä¹Ÿä¸èƒ½æ¥æ”¶æ•°æ®ã€‚<br />ä¸€æ—¦ä¸¤å°ä¸»æœºä¹‹é—´å»ºç«‹äº†å¥—æ¥å­—è¿æ¥ï¼Œæ¯ä¸ªä¸»æœºå°±ä¼šæ‹¥æœ‰å•ç‹¬çš„è¾“å…¥æµå’Œè¾“å‡ºæµã€‚</p>
<h4 id="é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„-shutdown-å‡½æ•°"><a href="#é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„-shutdown-å‡½æ•°" class="anchor-link">#</a>é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„ shutdown å‡½æ•°</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">sock: éœ€è¦æ–­å¼€å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="cm">howto: ä¼ é€’æ–­å¼€æ–¹å¼ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm">	SHUT_RD : æ–­å¼€è¾“å…¥æµ 0
</span></span></span><span class="line"><span class="cl"><span class="cm">    SHUT_WR : æ–­å¼€è¾“å‡ºæµ 1
</span></span></span><span class="line"><span class="cl"><span class="cm">    SHUT_RDWR : åŒæ—¶æ–­å¼€ I/O æµ 2
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><a href="https://www.cnblogs.com/JohnABC/p/7238241.html" target="_blank" rel="noopener">Linux-socketçš„closeå’ŒshutdownåŒºåˆ«åŠåº”ç”¨åœºæ™¯</a>ï¼ˆä¹Ÿæœ‰åç»­ç« èŠ‚çš„å¤šè¿›ç¨‹ä¼ è¾“ä¸­ä½¿ç”¨shutdownçš„åŸå› ï¼Œä¼šä¸ç®¡è®¡æ•°ï¼Œç›´æ¥å…³é—­è¾“å…¥è¾“å‡ºæµï¼‰</p>
<h4 id="ä¸ºä½•è¦åŠå…³é—­"><a href="#ä¸ºä½•è¦åŠå…³é—­" class="anchor-link">#</a>ä¸ºä½•è¦åŠå…³é—­</h4>
<p>ä¸ºäº†å…³é—­æœåŠ¡å™¨åï¼Œä»å¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯çš„æ•°æ®ã€‚è°ƒç”¨ shutdown å‡½æ•°ï¼Œåªå…³é—­æœåŠ¡å™¨çš„è¾“å‡ºæµã€‚è¿™æ ·æ—¢å¯ä»¥å‘é€ EOF ï¼ŒåŒæ—¶åˆä¿ç•™äº†è¾“å…¥æµã€‚</p>
<h4 id="ä¸€ä¸ªä¼˜é›…çš„æµç¨‹"><a href="#ä¸€ä¸ªä¼˜é›…çš„æµç¨‹" class="anchor-link">#</a>ä¸€ä¸ªä¼˜é›…çš„æµç¨‹</h4>
<p>å½“æœåŠ¡ç«¯å‘é€å®Œæ•°æ®åï¼Œshutdownå…³é—­å‘é€æµï¼Œå½“æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å›å¤ä¿¡æ¯ï¼Œåˆ™closeå¥—æ¥å­—ï¼ŒåŒæ—¶å®¢æˆ·ç«¯å‘é€å®Œæ¶ˆæ¯åå…³é—­å¥—æ¥å­—ã€‚<br /><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-5.png?imageMogr2/format/webp%7C" alt="image"></p>
<h2 id="åŸŸååŠç½‘ç»œåœ°å€"><a href="#åŸŸååŠç½‘ç»œåœ°å€" class="anchor-link">#</a>åŸŸååŠç½‘ç»œåœ°å€</h2>
<h3 id="åŸŸåç³»ç»Ÿ"><a href="#åŸŸåç³»ç»Ÿ" class="anchor-link">#</a>åŸŸåç³»ç»Ÿ</h3>
<p>DNS æ˜¯å¯¹IPåœ°å€å’ŒåŸŸåè¿›è¡Œç›¸äº’è½¬æ¢çš„ç³»ç»Ÿï¼Œå…¶æ ¸å¿ƒæ˜¯ DNS æœåŠ¡å™¨<br />åŸŸåæ˜¯IPåœ°å€çš„åˆ«åï¼Œå¯ä»¥é€šè¿‡DNSæœåŠ¡å™¨æŸ¥è¯¢åˆ°å¯¹åº”IPåœ°å€<br /><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-6.png?imageMogr2/format/webp%7C" alt="image"><br />å½“åœ¨ç”µè„‘æµè§ˆå™¨ä¸Šè¾“å…¥ä¸€ä¸ªåŸŸåï¼Œä¼šé€šè¿‡ä¸€ç³»åˆ—çš„DNSæœåŠ¡å™¨çš„æ˜ å°„æ‰¾åˆ°æœ€ç»ˆçš„ç›®æ ‡æœåŠ¡å™¨ã€‚</p>
<h3 id="ipåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢"><a href="#ipåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢" class="anchor-link">#</a>IPåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢</h3>
<h4 id="é€šè¿‡åŸŸåè·å¾—ip"><a href="#é€šè¿‡åŸŸåè·å¾—ip" class="anchor-link">#</a>é€šè¿‡åŸŸåè·å¾—ip</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span><span class="nf">gethostbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› hostent ç»“æ„ä½“åœ°å€ï¼Œå¤±è´¥æ—¶è¿”å› NULL æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">hostent</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">h_name</span><span class="p">;</span>       <span class="cm">/* Official name of host.  å®˜æ–¹åŸŸå*/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">**</span><span class="n">h_aliases</span><span class="p">;</span>   <span class="cm">/* Alias list.  åŸŸååˆ«ç§°*/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">h_addrtype</span><span class="p">;</span>     <span class="cm">/* Host address type.  IPåœ°å€*/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">h_length</span><span class="p">;</span>       <span class="cm">/* Length of address.  IPåœ°å€é•¿åº¦*/</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">**</span><span class="n">h_addr_list</span><span class="p">;</span> <span class="cm">/* List of addresses from name server. åŸŸåå¯¹åº”IPåœ°å€ */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-7.png?imageMogr2/format/webp%7C" alt="image"><br />linuxä¸‹å¯ä»¥ä½¿ç”¨dig @8.8.8.8 +trace baidu.comå‘½ä»¤è¿½è¸ªDNSæŸ¥è¯¢è·¯å¾„</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">error_handling</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage : %s &lt;addr&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œè¿”å›ç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">host</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// IP to host
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// struct sockaddr_in addr;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// memset(&amp;addr, 0, sizeof(addr));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// addr.sin_addr.s_addr = inet_addr(argv[1]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// host = gethostbyaddr((char *)&amp;addr.sin_addr, 4, AF_INET);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;gethost... error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¾“å‡ºå®˜æ–¹åŸŸå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Official name: %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Aliases è²Œä¼¼æ˜¯è§£æçš„ cname åŸŸåï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Aliases %d: %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_aliases</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//çœ‹çœ‹æ˜¯ä¸æ˜¯ipv4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Address type: %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_addrtype</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;AF_INET&#34;</span> <span class="o">:</span> <span class="s">&#34;AF_INET6&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¾“å‡ºipåœ°å€ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¯¹in_addr*æŒ‡é’ˆå–å€¼ç”¨*
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;IP addr %d: %s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="åˆ©ç”¨ipåœ°å€è·å–åŸŸå"><a href="#åˆ©ç”¨ipåœ°å€è·å–åŸŸå" class="anchor-link">#</a>åˆ©ç”¨IPåœ°å€è·å–åŸŸå</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;netdb.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span><span class="nf">gethostbyaddr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› hostent ç»“æ„ä½“å˜é‡åœ°å€å€¼ï¼Œå¤±è´¥æ—¶è¿”å› NULL æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">addr: å«æœ‰IPåœ°å€ä¿¡æ¯çš„ in_addr ç»“æ„ä½“æŒ‡é’ˆã€‚ä¸ºäº†åŒæ—¶ä¼ é€’ IPV4 åœ°å€ä¹‹å¤–çš„å…¨éƒ¨ä¿¡æ¯ï¼Œè¯¥å˜é‡çš„ç±»å‹å£°æ˜ä¸º char æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">len: å‘ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’çš„åœ°å€ä¿¡æ¯çš„å­—èŠ‚æ•°ï¼ŒIPV4æ—¶ä¸º 4 ï¼ŒIPV6 æ—¶ä¸º16.
</span></span></span><span class="line"><span class="cl"><span class="cm">family: ä¼ é€’åœ°å€æ—ä¿¡æ¯ï¼Œipv4 æ˜¯ AF_INET ï¼ŒIPV6æ˜¯ AF_INET6
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p><a href="https://www.zhihu.com/question/34873227/answer/518086565" target="_blank" rel="noopener">åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ä¸€ä¸ªURLåå›è½¦ï¼ŒèƒŒåä¼šè¿›è¡Œå“ªäº›æŠ€æœ¯æ­¥éª¤ï¼Ÿ</a></p>
<h2 id="å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹"><a href="#å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹" class="anchor-link">#</a>å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹</h2>
<h3 id="å¥—æ¥å­—å¯é€‰é¡¹å’Œ-io-ç¼“å†²å¤§å°"><a href="#å¥—æ¥å­—å¯é€‰é¡¹å’Œ-io-ç¼“å†²å¤§å°" class="anchor-link">#</a>å¥—æ¥å­—å¯é€‰é¡¹å’Œ I/O ç¼“å†²å¤§å°</h3>
<p>æˆ‘ä»¬ä¹‹å‰å†™å¾—ç¨‹åºéƒ½æ˜¯åˆ›å»ºå¥½å¥—æ¥å­—ä¹‹åç›´æ¥ä½¿ç”¨çš„ï¼Œæ­¤æ—¶é€šè¿‡é»˜è®¤çš„å¥—æ¥å­—ç‰¹æ€§è¿›è¡Œæ•°æ®é€šä¿¡ï¼Œè¿™é‡Œåˆ—å‡ºäº†ä¸€äº›å¥—æ¥å­—å¯é€‰é¡¹ã€‚</p>
<div class="table-container"><table>
  <thead>
      <tr>
          <th>åè®®å±‚</th>
          <th>é€‰é¡¹å</th>
          <th>getsockopt</th>
          <th>setsockopt</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_SNDBUF</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_RCVBUF</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_REUSEADDR</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_KEEPALIVE</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_BROADCAST</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_DONTROUTE</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_OOBINLINE</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_ERROR</td>
          <td>O</td>
          <td>X</td>
      </tr>
      <tr>
          <td>SOL_SOCKET</td>
          <td>SO_TYPE</td>
          <td>O</td>
          <td>X</td>
      </tr>
      <tr>
          <td>IPPROTO_IP</td>
          <td>IP_TOS</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_IP</td>
          <td>IP_TTL</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_IP</td>
          <td>IP_MULTICAST_TTL</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_IP</td>
          <td>IP_MULTICAST_LOOP</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_IP</td>
          <td>IP_MULTICAST_IF</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_TCP</td>
          <td>TCP_KEEPALIVE</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_TCP</td>
          <td>TCP_NODELAY</td>
          <td>O</td>
          <td>O</td>
      </tr>
      <tr>
          <td>IPPROTO_TCP</td>
          <td>TCP_MAXSEG</td>
          <td>O</td>
          <td>O</td>
      </tr>
  </tbody>
</table></div>
<p>ä»è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¥—æ¥å­—å¯é€‰é¡¹æ˜¯åˆ†å±‚çš„ã€‚</p>
<ul>
<li>IPPROTO_IP å¯é€‰é¡¹æ˜¯IPåè®®ç›¸å…³äº‹é¡¹</li>
<li>IPPROTO_TCP å±‚å¯é€‰é¡¹æ˜¯ TCP åè®®çš„ç›¸å…³äº‹é¡¹</li>
<li>SOL_SOCKET å±‚æ˜¯å¥—æ¥å­—çš„é€šç”¨å¯é€‰é¡¹ã€‚</li>
<li>ç”¨äºéªŒè¯å¥—æ¥ç±»å‹çš„ SO_TYPE æ˜¯åªè¯»å¯é€‰é¡¹ï¼Œå› ä¸º<strong>å¥—æ¥å­—ç±»å‹åªèƒ½åœ¨åˆ›å»º(è°ƒç”¨socket()æ–¹æ³•æ—¶)æ—¶å†³å®šï¼Œä»¥åä¸èƒ½å†æ›´æ”¹</strong>ã€‚</li>
</ul>
<h4 id="getsockopt--setsockopt"><a href="#getsockopt--setsockopt" class="anchor-link">#</a>getsockopt &amp; setsockopt</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// è¯»å–å¥—æ¥å­—å¯é€‰é¡¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">getsockopt</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">optlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">sock: ç”¨äºæŸ¥çœ‹é€‰é¡¹å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="cm">level: è¦æŸ¥çœ‹çš„å¯é€‰é¡¹åè®®å±‚
</span></span></span><span class="line"><span class="cl"><span class="cm">optname: è¦æŸ¥çœ‹çš„å¯é€‰é¡¹å
</span></span></span><span class="line"><span class="cl"><span class="cm">optval: ä¿å­˜æŸ¥çœ‹ç»“æœçš„ç¼“å†²åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">optlen: å‘ç¬¬å››ä¸ªå‚æ•°ä¼ é€’çš„ç¼“å†²å¤§å°ã€‚è°ƒç”¨å‡½æ•°åï¼Œè¯¥å˜é‡ä¸­ä¿å­˜é€šè¿‡ç¬¬å››ä¸ªå‚æ•°è¿”å›çš„å¯é€‰é¡¹ä¿¡æ¯çš„å­—èŠ‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// æ›´æ”¹å¯é€‰é¡¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">setsockopt</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">optlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">sock: ç”¨äºæ›´æ”¹é€‰é¡¹å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="cm">level: è¦æ›´æ”¹çš„å¯é€‰é¡¹åè®®å±‚
</span></span></span><span class="line"><span class="cl"><span class="cm">optname: è¦æ›´æ”¹çš„å¯é€‰é¡¹å
</span></span></span><span class="line"><span class="cl"><span class="cm">optval: ä¿å­˜æ›´æ”¹ç»“æœçš„ç¼“å†²åœ°å€å€¼
</span></span></span><span class="line"><span class="cl"><span class="cm">optlen: å‘ç¬¬å››ä¸ªå‚æ•°ä¼ é€’çš„ç¼“å†²å¤§å°ã€‚è°ƒç”¨å‡½æ•°åï¼Œè¯¥å˜é‡ä¸­ä¿å­˜é€šè¿‡ç¬¬å››ä¸ªå‚æ•°è¿”å›çš„å¯é€‰é¡¹ä¿¡æ¯çš„å­—èŠ‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">tcp_sock</span><span class="p">,</span> <span class="n">udp_sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sock_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">socklen_t</span> <span class="n">optlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">optlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sock_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tcp_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">udp_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;SOCK_STREAM: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;SOCK_DGRAM: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="n">getsockopt</span><span class="p">(</span><span class="n">tcp_sock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_TYPE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sock_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Socket type one: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sock_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="n">getsockopt</span><span class="p">(</span><span class="n">udp_sock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_TYPE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sock_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Socket type two: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sock_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="so_sndbuf--so_rcvbuf"><a href="#so_sndbuf--so_rcvbuf" class="anchor-link">#</a>SO_SNDBUF &amp; SO_RCVBUF</h4>
<p>è®¾ç½®ç¼“å†²åŒºä¸ä¼šæŒ‰ç…§ä»£ç æ‰€è¦æ±‚çš„ç¼“å†²åŒºå¤§å°ï¼Œæ‰€ä»¥å®ç°è¦å°å¿ƒã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Set socket FD&#39;s option OPTNAME at protocol level LEVEL
</span></span></span><span class="line"><span class="cl"><span class="cm">   to *OPTVAL (which is OPTLEN bytes long).
</span></span></span><span class="line"><span class="cl"><span class="cm">   Returns 0 on success, -1 for errors.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">setsockopt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__optname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__optval</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">__optlen</span><span class="p">)</span> <span class="n">__THROW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Put the current value for socket FD&#39;s option OPTNAME at protocol level LEVEL
</span></span></span><span class="line"><span class="cl"><span class="cm">   into OPTVAL (which is *OPTLEN bytes long), and set *OPTLEN to the value&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">   actual length.  Returns 0 on success, -1 for errors.  */</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">getsockopt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__optname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="kt">void</span> <span class="o">*</span><span class="n">__restrict</span> <span class="n">__optval</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="n">socklen_t</span> <span class="o">*</span><span class="n">__restrict</span> <span class="n">__optlen</span><span class="p">)</span> <span class="n">__THROW</span><span class="p">;</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="so_reuseaddrimportant"><a href="#so_reuseaddrimportant" class="anchor-link">#</a>SO_REUSEADDRï¼ˆimportantï¼‰</h3>
<h4 id="time-wait-çŠ¶æ€"><a href="#time-wait-çŠ¶æ€" class="anchor-link">#</a>Time-wait çŠ¶æ€</h4>
<p><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-8.png?imageMogr2/format/webp%7C" alt="image"><br />å‡è®¾å›¾ä¸­ä¸»æœº A æ˜¯æœåŠ¡å™¨ï¼Œå› ä¸ºæ˜¯ä¸»æœº A å‘ B å‘é€ FIN æ¶ˆæ¯ï¼Œå³æœåŠ¡å™¨ä½¿ç”¨ CTRL+Cå¼ºåˆ¶ç»ˆæ­¢ ã€‚ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œå¥—æ¥å­—ç»è¿‡å››æ¬¡æ¡æ‰‹åå¹¶æ²¡æœ‰ç«‹å³æ¶ˆé™¤ï¼Œè€Œæ˜¯è¦ç»è¿‡ä¸€æ®µæ—¶é—´çš„ Time-wait çŠ¶æ€ã€‚å½“ç„¶ï¼Œåªæœ‰<strong>å…ˆæ–­å¼€è¿æ¥</strong>çš„ï¼ˆ<strong>å…ˆå‘é€ FIN æ¶ˆæ¯</strong>çš„ï¼‰ä¸»æœºæ‰ç»è¿‡ Time-wait çŠ¶æ€ã€‚å› æ­¤ï¼Œè‹¥æœåŠ¡å™¨ç«¯å…ˆæ–­å¼€è¿æ¥ï¼Œåˆ™æ— æ³•ç«‹å³é‡æ–°è¿è¡Œã€‚å¥—æ¥å­—å¤„åœ¨ Time-wait è¿‡ç¨‹æ—¶ï¼Œç›¸åº”ç«¯å£æ˜¯æ­£åœ¨ä½¿ç”¨çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œå°±åƒä¹‹å‰éªŒè¯è¿‡çš„ï¼Œbind å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé”™è¯¯ã€‚<br />å®é™…ä¸Šï¼Œä¸è®ºæ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œéƒ½è¦ç»è¿‡ä¸€æ®µæ—¶é—´çš„ Time-wait è¿‡ç¨‹ã€‚å…ˆæ–­å¼€è¿æ¥çš„å¥—æ¥å­—å¿…ç„¶ä¼šç»è¿‡ Time-wait è¿‡ç¨‹ï¼Œä½†æ˜¯ç”±äº<strong>å®¢æˆ·ç«¯å¥—æ¥å­—çš„ç«¯å£æ˜¯ä»»æ„æŒ‡å®š</strong>çš„ï¼Œæ‰€ä»¥æ— éœ€è¿‡å¤šå…³æ³¨ Time-wait çŠ¶æ€ã€‚<br />é‚£åˆ°åº•ä¸ºä»€ä¹ˆä¼šæœ‰ Time-wait çŠ¶æ€å‘¢ï¼Œåœ¨å›¾ä¸­å‡è®¾ï¼Œä¸»æœº A å‘ä¸»æœº B ä¼ è¾“ ACK æ¶ˆæ¯ï¼ˆSEQ 5001 , ACK 7502 ï¼‰åç«‹åˆ»æ¶ˆé™¤å¥—æ¥å­—ã€‚ä½†æ˜¯æœ€åè¿™æ¡ ACK æ¶ˆæ¯åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œæ²¡æœ‰ä¼ é€’ä¸»æœº B ï¼Œè¿™æ—¶ä¸»æœº B å°±ä¼šè¯•å›¾é‡ä¼ ã€‚ä½†æ˜¯æ­¤æ—¶ä¸»æœº A å·²ç»æ˜¯å®Œå…¨ç»ˆæ­¢çŠ¶æ€ï¼Œå› æ­¤ä¸»æœº B æ°¸è¿œæ— æ³•æ”¶åˆ°ä»ä¸»æœº A æœ€åä¼ æ¥çš„ ACK æ¶ˆæ¯ã€‚é˜²æ­¢æ•°æ®ä¸¢å¤±åï¼Œæ— æ³•å†æ¬¡é€šä¿¡ï¼Œæ‰€ä»¥è¦è®¾è®¡ Time-wait çŠ¶æ€ã€‚</p>
<h4 id="åœ°å€å†åˆ†é…"><a href="#åœ°å€å†åˆ†é…" class="anchor-link">#</a>åœ°å€å†åˆ†é…</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">socklen_t</span> <span class="n">optlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">option</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">setsockopt</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">option</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="tcp_nodelay"><a href="#tcp_nodelay" class="anchor-link">#</a>TCP_NODELAY</h3>
<p><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-9.png?imageMogr2/format/webp%7C" alt="image"><br />TCP å¥—æ¥å­—é»˜è®¤ä½¿ç”¨ Nagle ç®—æ³•äº¤æ¢æ•°æ®ï¼Œå› æ­¤æœ€å¤§é™åº¦çš„è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°æ”¶åˆ° ACK ã€‚å·¦å›¾ä¹Ÿå°±æ˜¯è¯´ä¸€å…±ä¼ é€’ 4 ä¸ªæ•°æ®åŒ…ä»¥ä¼ è¾“ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ä»å³å›¾å¯ä»¥çœ‹å‡ºï¼Œå‘é€æ•°æ®åŒ…ä¸€å…±ä½¿ç”¨äº† 10 ä¸ªæ•°æ®åŒ…ã€‚ç”±æ­¤å¯çŸ¥ï¼Œä¸ä½¿ç”¨ Nagle ç®—æ³•å°†å¯¹ç½‘ç»œæµé‡äº§ç”Ÿè´Ÿé¢å½±å“ã€‚å³ä½¿åªä¼ è¾“ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå…¶å¤´ä¿¡æ¯éƒ½å¯èƒ½æ˜¯å‡ åä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼Œå¿…é¡»ä½¿ç”¨ Nagle ç®—æ³•ã€‚<br />Nagle ç®—æ³•å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹éƒ½é€‚ç”¨ï¼Œ<strong>ç½‘ç»œæµé‡æœªå—å¤ªå¤§å½±å“æ—¶</strong>ï¼Œä¸ä½¿ç”¨ Nagle ç®—æ³•è¦æ¯”ä½¿ç”¨å®ƒæ—¶ä¼ è¾“é€Ÿåº¦å¿«ã€‚æœ€å…¸å‹çš„å°±æ˜¯ã€Œ<strong>ä¼ è¾“å¤§æ–‡æ•°æ®</strong>ã€ã€‚å°†æ–‡ä»¶æ•°æ®ä¼ å…¥è¾“å‡ºç¼“å†²ä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´ï¼Œå› æ­¤ï¼Œä¸ä½¿ç”¨ Nagle ç®—æ³•ï¼Œä¹Ÿä¼šåœ¨è£…æ»¡è¾“å‡ºç¼“å†²æ—¶ä¼ è¾“æ•°æ®åŒ…ã€‚è¿™ä¸ä»…ä¸ä¼šå¢åŠ æ•°æ®åŒ…çš„æ•°é‡ï¼Œåè€Œåœ¨æ— éœ€ç­‰å¾… ACK çš„å‰æä¸‹è¿ç»­ä¼ è¾“ï¼Œå› æ­¤å¯ä»¥å¤§å¤§æé«˜ä¼ è¾“é€Ÿåº¦ã€‚<br />æ‰€ä»¥ï¼Œæœªå‡†ç¡®åˆ¤æ–­æ•°æ®æ€§è´¨æ—¶ä¸åº”ç¦ç”¨ Nagle ç®—æ³•ã€‚</p>
<h4 id="ç¦ç”¨-nagle-ç®—æ³•"><a href="#ç¦ç”¨-nagle-ç®—æ³•" class="anchor-link">#</a>ç¦ç”¨ Nagle ç®—æ³•</h4>
<p>ç¦ç”¨ Nagle ç®—æ³•åº”è¯¥ä½¿ç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;netinet/tcp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">opt_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">opt_val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt_val</span><span class="p">));</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>é€šè¿‡ TCP_NODELAY çš„å€¼æ¥æŸ¥çœ‹Nagle ç®—æ³•çš„è®¾ç½®çŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">opt_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opt_val</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="n">getsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">opt_val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opt_len</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>å¦‚æœæ­£åœ¨ä½¿ç”¨Nagle ç®—æ³•ï¼Œé‚£ä¹ˆ opt_val å€¼ä¸º 0ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼Œå¦‚æœç¦ç”¨åˆ™ä¸º 1.<br />å…³äºè¿™ä¸ªç®—æ³•ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªå›ç­”ï¼š<a href="https://www.zhihu.com/question/42308970/answer/246334766" target="_blank" rel="noopener">TCPè¿æ¥ä¸­å¯ç”¨å’Œç¦ç”¨TCP_NODELAYæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</a></p>
<h2 id="å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯"><a href="#å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯" class="anchor-link">#</a>å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯</h2>
<p>é€šè¿‡æ”¹è¿›æœåŠ¡ç«¯ï¼Œä½¿å…¶åŒæ—¶å‘æ‰€æœ‰å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œä»¥æé«˜å¹³å‡æ»¡æ„åº¦ã€‚è€Œä¸”ï¼Œç½‘ç»œç¨‹åºä¸­æ•°æ®é€šä¿¡æ—¶é—´æ¯” CPU è¿ç®—æ—¶é—´å æ¯”æ›´å¤§ï¼Œå› æ­¤ï¼Œå‘å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡æ˜¯ä¸€ç§æœ‰æ•ˆçš„åˆ©ç”¨ CPU çš„æ–¹å¼ã€‚</p>
<ul>
<li>å¤šè¿›ç¨‹æœåŠ¡å™¨ï¼šé€šè¿‡åˆ›å»ºå¤šä¸ªè¿›ç¨‹æä¾›æœåŠ¡</li>
<li>å¤šè·¯å¤ç”¨æœåŠ¡å™¨ï¼šé€šè¿‡æ†ç»‘å¹¶ç»Ÿä¸€ç®¡ç† I/O å¯¹è±¡æä¾›æœåŠ¡</li>
<li>å¤šçº¿ç¨‹æœåŠ¡å™¨ï¼šé€šè¿‡ç”Ÿæˆä¸å®¢æˆ·ç«¯ç­‰é‡çš„çº¿ç¨‹æä¾›æœåŠ¡</li>
</ul>
<h3 id="è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨"><a href="#è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨" class="anchor-link">#</a>è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨</h3>
<h4 id="ç†è§£è¿›ç¨‹"><a href="#ç†è§£è¿›ç¨‹" class="anchor-link">#</a>ç†è§£è¿›ç¨‹</h4>
<p>è¿›ç¨‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å ç”¨å†…å­˜ç©ºé—´çš„æ­£åœ¨è¿è¡Œçš„ç¨‹åº</p>
</blockquote>
<p>æ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿåˆ†é…ä¸€ä¸ª IDã€‚æ­¤ ID è¢«ç§°ä¸ºã€Œè¿›ç¨‹IDã€ï¼Œå…¶å€¼ä¸ºå¤§äº 2 çš„æ•´æ•°ã€‚1 è¦åˆ†é…ç»™æ“ä½œç³»ç»Ÿå¯åŠ¨åçš„ï¼ˆç”¨äºååŠ©æ“ä½œç³»ç»Ÿï¼‰é¦–ä¸ªè¿›ç¨‹ã€‚<br />linuxè¿è¡Œ ps au å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
<h4 id="è°ƒç”¨-fork-å‡½æ•°åˆ›å»ºè¿›ç¨‹"><a href="#è°ƒç”¨-fork-å‡½æ•°åˆ›å»ºè¿›ç¨‹" class="anchor-link">#</a>è°ƒç”¨ fork å‡½æ•°åˆ›å»ºè¿›ç¨‹</h4>
<p>åˆ›å»ºè¿›ç¨‹çš„æ–¹å¼å¾ˆå¤šï¼Œæ­¤å¤„åªä»‹ç»ç”¨äºåˆ›å»ºå¤šè¿›ç¨‹æœåŠ¡ç«¯çš„ fork å‡½æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">pid_t</span> <span class="nf">fork</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>fork å‡½æ•°å°†åˆ›å»ºè°ƒç”¨çš„è¿›ç¨‹å‰¯æœ¬ï¼Œå¤åˆ¶æ­£åœ¨è¿è¡Œçš„ã€è°ƒç”¨ fork å‡½æ•°çš„è¿›ç¨‹ã€‚å¦å¤–ï¼Œä¸¤ä¸ªè¿›ç¨‹éƒ½æ‰§è¡Œ fork å‡½æ•°è°ƒç”¨åçš„æ‰€æœ‰è¯­å¥ã€‚ä½†å› ä¸ºæ˜¯é€šè¿‡åŒä¸€ä¸ªè¿›ç¨‹ã€å¤åˆ¶ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä¹‹åçš„ç¨‹åºæµè¦æ ¹æ® fork å‡½æ•°çš„è¿”å›å€¼ç”¨if/elseåŠ ä»¥åŒºåˆ†ã€‚å³åˆ©ç”¨ fork å‡½æ•°çš„å¦‚ä¸‹ç‰¹ç‚¹åŒºåˆ†ç¨‹åºæ‰§è¡Œæµç¨‹ã€‚</p>
<ul>
<li>çˆ¶è¿›ç¨‹ï¼šfork å‡½æ•°è¿”å›å­è¿›ç¨‹ ID</li>
<li>å­è¿›ç¨‹ï¼šfork å‡½æ•°è¿”å› 0</li>
</ul>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="n">gval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">lval</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gval</span><span class="o">++</span><span class="p">,</span> <span class="n">lval</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å…ˆå‰gval=11, lval = 25
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// å­è¿›ç¨‹æ“ä½œval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">gval</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lval</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>  <span class="c1">// çˆ¶è¿›ç¨‹æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">gval</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lval</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child Proc: [%d,%d] </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">gval</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>  <span class="c1">// [13, 27]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Parent Proc: [%d,%d] </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">gval</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>  <span class="c1">// [9, 23]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="åƒµå°¸è¿›ç¨‹"><a href="#åƒµå°¸è¿›ç¨‹" class="anchor-link">#</a>åƒµå°¸è¿›ç¨‹</h3>
<blockquote>
<p>åƒµå°¸è¿›ç¨‹æ˜¯å½“å­è¿›ç¨‹æ¯”çˆ¶è¿›ç¨‹å…ˆç»“æŸï¼Œè€Œçˆ¶è¿›ç¨‹åˆæ²¡æœ‰å›æ”¶å­è¿›ç¨‹ï¼Œé‡Šæ”¾å­è¿›ç¨‹å ç”¨çš„èµ„æºï¼Œæ­¤æ—¶å­è¿›ç¨‹å°†æˆä¸ºä¸€ä¸ªåƒµå°¸è¿›ç¨‹ã€‚å¦‚æœçˆ¶è¿›ç¨‹å…ˆé€€å‡º ï¼Œå­è¿›ç¨‹è¢«initæ¥ç®¡ï¼Œå­è¿›ç¨‹é€€å‡ºåinitä¼šå›æ”¶å…¶å ç”¨çš„ç›¸å…³èµ„æº</p>
</blockquote>
<p>ä½¿ç”¨ps au æŸ¥çœ‹åƒµå°¸è¿›ç¨‹æ—¶ï¼Œå…¶statä¸ºZï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨statï¼Œå¯ç»„åˆä½¿ç”¨</p>
<blockquote>
<p>D      //æ— æ³•ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ˆé€šå¸¸ IO çš„è¿›ç¨‹ï¼‰ï¼› <br />R      //æ­£åœ¨è¿è¡Œå¯ä¸­åœ¨é˜Ÿåˆ—ä¸­å¯è¿‡è¡Œçš„ï¼› <br />S      //å¤„äºä¼‘çœ çŠ¶æ€ï¼› <br />T      //åœæ­¢æˆ–è¢«è¿½è¸ªï¼› <br />W      //è¿›å…¥å†…å­˜äº¤æ¢ ï¼ˆä»å†…æ ¸2.6å¼€å§‹æ— æ•ˆï¼‰ï¼› <br />X      //æ­»æ‰çš„è¿›ç¨‹ ï¼ˆåŸºæœ¬å¾ˆå°‘è§ï¼‰ï¼› <br />Z      //åƒµå°¸è¿›ç¨‹ï¼› <br />&lt;      //ä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹ <br />N      //ä¼˜å…ˆçº§è¾ƒä½çš„è¿›ç¨‹ <br />L      //æœ‰äº›é¡µè¢«é”è¿›å†…å­˜ï¼› <br />s      //è¿›ç¨‹çš„é¢†å¯¼è€…ï¼ˆåœ¨å®ƒä¹‹ä¸‹æœ‰å­è¿›ç¨‹ï¼‰ï¼› <br />l      //å¤šçº¿ç¨‹ï¼Œå…‹éš†çº¿ç¨‹ï¼ˆä½¿ç”¨ CLONE_THREAD, ç±»ä¼¼ NPTL pthreadsï¼‰ï¼› <br />+      //ä½äºåå°çš„è¿›ç¨‹ç»„ï¼›ï¼ˆæ­£åœ¨ä½¿ç”¨çš„è¿›ç¨‹ï¼Ÿï¼‰</p>
</blockquote>
<h4 id="äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› "><a href="#äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› " class="anchor-link">#</a>äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› </h4>
<p>å‘ exit å‡½æ•°ä¼ é€’çš„å‚æ•°å€¼(e.g. 0)å’Œ main å‡½æ•°çš„ return è¯­å¥è¿”å›çš„å€¼(e.g. 0)éƒ½ä¼šä¼ é€’ç»™æ“ä½œç³»ç»Ÿã€‚è€Œæ“ä½œç³»ç»Ÿä¸ä¼šé”€æ¯å­è¿›ç¨‹ï¼Œ<strong>ç›´åˆ°æŠŠè¿™äº›å€¼ä¼ é€’ç»™äº§ç”Ÿè¯¥å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹</strong>ã€‚å¤„åœ¨è¿™ç§çŠ¶æ€ä¸‹çš„è¿›ç¨‹å°±æ˜¯åƒµå°¸è¿›ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´å°†å­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹çš„æ­£æ˜¯æ“ä½œç³»ç»Ÿã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œåƒµå°¸è¿›ç¨‹ä½•æ—¶è¢«é”€æ¯å‘¢ï¼Ÿçˆ¶è¿›ç¨‹ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼ˆwaitå‡½æ•°è°ƒç”¨ï¼‰çš„æ—¶å€™ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Hi, I am a child Process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child Process ID: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>  <span class="c1">// ä½¿å­è¿›ç¨‹å˜åƒµå°¸ï¼Œ30såå†ç»ˆæ­¢å­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;End child proess&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;End parent process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><blockquote>
<p>åˆ©ç”¨ ./zombie &amp;å¯ä»¥ä½¿ç¨‹åºåœ¨åå°è¿è¡Œï¼Œä¸ç”¨æ‰“å¼€æ–°çš„å‘½ä»¤è¡Œçª—å£ã€‚è¾“å…¥ps auæŸ¥çœ‹Z</p>
</blockquote>
<h4 id="é”€æ¯åƒµå°¸è¿›ç¨‹-1åˆ©ç”¨-wait-å‡½æ•°"><a href="#é”€æ¯åƒµå°¸è¿›ç¨‹-1åˆ©ç”¨-wait-å‡½æ•°" class="anchor-link">#</a>é”€æ¯åƒµå°¸è¿›ç¨‹ 1ï¼šåˆ©ç”¨ wait å‡½æ•°</h4>
<p>ä¸ºäº†é”€æ¯å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹åº”è¯¥ä¸»åŠ¨è¯·æ±‚è·å–å­è¿›ç¨‹çš„è¿”å›å€¼ã€‚ä¸‹é¢æ˜¯å‘èµ·è¯·æ±‚çš„å…·ä½“æ–¹æ³•ï¼Œæœ‰ä¸¤ç§ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">pid_t</span> <span class="nf">wait</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">statloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹ ID ,å¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>è°ƒç”¨æ­¤å‡½æ•°æ—¶å¦‚æœå·²æœ‰å­è¿›ç¨‹ç»ˆæ­¢ï¼Œé‚£ä¹ˆå­è¿›ç¨‹ç»ˆæ­¢æ—¶ä¼ é€’çš„è¿”å›å€¼ï¼ˆexit å‡½æ•°çš„å‚æ•°è¿”å›å€¼ï¼Œmain å‡½æ•°çš„ return è¿”å›å€¼ï¼‰å°†ä¿å­˜åˆ°è¯¥å‡½æ•°çš„å‚æ•°æ‰€æŒ‡çš„å†…å­˜ç©ºé—´ã€‚ä½†å‡½æ•°å‚æ•°æŒ‡å‘çš„å†…å­˜ç©ºé—´ä¸­è¿˜åŒ…å«å…¶ä»–ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ç”¨ä¸‹åˆ—å®è¿›è¡Œåˆ†ç¦»ï¼š</p>
<ul>
<li>WIFEXITED å­è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢æ—¶è¿”å›ã€ŒçœŸã€</li>
<li>WEXITSTATUS è¿”å›å­è¿›ç¨‹æ—¶çš„è¿”å›å€¼</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘ wait å‡½æ•°ä¼ é€’å˜é‡ status çš„åœ°å€æ—¶ï¼Œè°ƒç”¨ wait å‡½æ•°ååº”ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š<br />WIFIEXITEDï¼š((status) &amp; 0x7f) == 0<br />WEXITSTATUSï¼š(((status) &amp; 0xff00) &gt;&gt; 8)</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span> <span class="c1">//è¿™é‡Œçš„å­è¿›ç¨‹å°†åœ¨ç¬¬13è¡Œé€šè¿‡ return è¯­å¥ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child PID: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span> <span class="c1">//è¿™é‡Œçš„å­è¿›ç¨‹å°†åœ¨ 21 è¡Œé€šè¿‡ exit() å‡½æ•°ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child PID: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>         <span class="c1">//ä¹‹é—´ç»ˆæ­¢çš„å­è¿›ç¨‹ç›¸å…³ä¿¡æ¯å°†è¢«ä¿å­˜åˆ° status ä¸­ï¼ŒåŒæ—¶ç›¸å…³å­è¿›ç¨‹è¢«å®Œå…¨é”€æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="c1">//é€šè¿‡ WIFEXITED æ¥éªŒè¯å­è¿›ç¨‹æ˜¯å¦æ­£å¸¸ç»ˆæ­¢ã€‚å¦‚æœæ­£å¸¸ç»ˆæ­¢ï¼Œåˆ™è°ƒç”¨ WEXITSTATUS å®è¾“å‡ºå­è¿›ç¨‹è¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child send one: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span> <span class="c1">//å› ä¸ºä¹‹å‰åˆ›å»ºäº†ä¸¤ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥å†æ¬¡è°ƒç”¨ wait å‡½æ•°å’Œå®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child send two: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>è¿™å°±æ˜¯é€šè¿‡ wait å‡½æ•°æ¶ˆç­åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•ï¼Œè°ƒç”¨ wait å‡½æ•°æ—¶ï¼Œå¦‚æœæ²¡æœ‰å·²ç»ç»ˆæ­¢çš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆç¨‹åºå°†<strong>é˜»å¡ï¼ˆBlockingï¼‰ç›´åˆ°æœ‰å­è¿›ç¨‹ç»ˆæ­¢</strong>ï¼Œå› æ­¤è¦è°¨æ…è°ƒç”¨è¯¥å‡½æ•°ã€‚</p>
<h4 id="é”€æ¯åƒµå°¸è¿›ç¨‹-2ä½¿ç”¨-waitpid-å‡½æ•°"><a href="#é”€æ¯åƒµå°¸è¿›ç¨‹-2ä½¿ç”¨-waitpid-å‡½æ•°" class="anchor-link">#</a>é”€æ¯åƒµå°¸è¿›ç¨‹ 2ï¼šä½¿ç”¨ waitpid å‡½æ•°</h4>
<p>wait å‡½æ•°ä¼šå¼•èµ·ç¨‹åºé˜»å¡ï¼Œè¿˜å¯ä»¥è€ƒè™‘è°ƒç”¨ waitpid å‡½æ•°ã€‚è¿™æ˜¯é˜²æ­¢åƒµå°¸è¿›ç¨‹çš„ç¬¬äºŒç§æ–¹æ³•ï¼Œä¹Ÿæ˜¯é˜²æ­¢é˜»å¡çš„æ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">pid_t</span> <span class="nf">waitpid</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">statloc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹ID æˆ– 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">pid: ç­‰å¾…ç»ˆæ­¢çš„ç›®æ ‡å­è¿›ç¨‹çš„ID,è‹¥ä¼  -1ï¼Œåˆ™ä¸ wait å‡½æ•°ç›¸åŒï¼Œå¯ä»¥ç­‰å¾…ä»»æ„å­è¿›ç¨‹ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="cm">statloc: ä¸ wait å‡½æ•°çš„ statloc å‚æ•°å…·æœ‰ç›¸åŒå«ä¹‰
</span></span></span><span class="line"><span class="cl"><span class="cm">options: ä¼ é€’å¤´æ–‡ä»¶ sys/wait.h å£°æ˜çš„å¸¸é‡ WNOHANG ,å³ä½¿æ²¡æœ‰ç»ˆæ­¢çš„å­è¿›ç¨‹ä¹Ÿä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯è¿”å› 0 é€€å‡ºå‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">//ç”¨ sleep æ¨è¿Ÿå­è¿›ç¨‹çš„æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è°ƒç”¨waitpid ä¼ é€’å‚æ•° WNOHANG ï¼Œè¿™æ ·æ²¡æœ‰ç»ˆæ­¢çš„å­è¿›ç¨‹è¿”å›0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">puts</span><span class="p">(</span><span class="s">&#34;sleep 3 sec.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child send %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h3 id="ä¿¡å·å¤„ç†"><a href="#ä¿¡å·å¤„ç†" class="anchor-link">#</a>ä¿¡å·å¤„ç†</h3>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“äº†è¿›ç¨‹çš„åˆ›å»ºåŠé”€æ¯çš„åŠæ³•ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ã€‚</p>
<blockquote>
<p>å­è¿›ç¨‹ç©¶ç«Ÿä½•æ—¶ç»ˆæ­¢ï¼Ÿè°ƒç”¨ waitpid å‡½æ•°åè¦æ— ä¼‘æ­¢çš„ç­‰å¾…å—ï¼Ÿ</p>
</blockquote>
<p>å­è¿›ç¨‹ç»ˆæ­¢çš„è¯†åˆ«ä¸»é¢˜æ˜¯æ“ä½œç³»ç»Ÿï¼Œå› æ­¤ï¼Œè‹¥æ“ä½œç³»ç»Ÿèƒ½æŠŠå­è¿›ç¨‹ç»“æŸçš„ä¿¡æ¯å‘Šè¯‰æ­£å¿™äºå·¥ä½œçš„çˆ¶è¿›ç¨‹ï¼Œå°†æœ‰åŠ©äºæ„å»ºæ›´é«˜æ•ˆçš„ç¨‹åº<br />ä¸ºäº†å®ç°ä¸Šè¿°çš„åŠŸèƒ½ï¼Œå¼•å…¥ä¿¡å·å¤„ç†æœºåˆ¶ï¼ˆSignal Handingï¼‰ã€‚æ­¤å¤„ã€Œä¿¡å·ã€æ˜¯åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ç”±æ“ä½œç³»ç»Ÿå‘è¿›ç¨‹å‘é€çš„æ¶ˆæ¯ã€‚å¦å¤–ï¼Œä¸ºäº†å“åº”è¯¥æ¶ˆæ¯ï¼Œæ‰§è¡Œä¸æ¶ˆæ¯ç›¸å…³çš„è‡ªå®šä¹‰æ“ä½œçš„è¿‡ç¨‹è¢«ç§°ä¸ºã€Œå¤„ç†ã€æˆ–ã€Œä¿¡å·å¤„ç†ã€ï¼ˆQTä¿¡å·æ§½ï¼Ÿï¼‰ã€‚</p>
<h4 id="ä¿¡å·ä¸-signal-å‡½æ•°"><a href="#ä¿¡å·ä¸-signal-å‡½æ•°" class="anchor-link">#</a>ä¿¡å·ä¸ signal å‡½æ•°</h4>
<p>ä¸‹é¢è¿›ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„å¯¹è¯å¯ä»¥å¸®åŠ©ç†è§£ä¿¡å·å¤„ç†ã€‚</p>
<blockquote>
<p>è¿›ç¨‹ï¼šæ“ä½œç³»ç»Ÿï¼Œå¦‚æœæˆ‘ä¹‹å‰åˆ›å»ºçš„å­è¿›ç¨‹ç»ˆæ­¢ï¼Œå°±å¸®æˆ‘è°ƒç”¨ zombie_handler å‡½æ•°ã€‚
æ“ä½œç³»ç»Ÿï¼šå¥½çš„ï¼Œå¦‚æœä½ çš„å­è¿›ç¨‹ç»ˆæ­¢ï¼Œæˆ‘å°±å¸®ä½ è°ƒç”¨ zombie_handler å‡½æ•°ï¼Œä½ å…ˆæŠŠå‡½æ•°è¦æ‰§è¡Œçš„è¯­å¥å†™å¥½ã€‚</p>
</blockquote>
<ol>
<li>ä¸Šè¿°çš„å¯¹è¯ï¼Œç›¸å½“äºã€Œæ³¨å†Œä¿¡å·ã€çš„è¿‡ç¨‹ã€‚</li>
</ol>
<p>å³è¿›ç¨‹å‘ç°è‡ªå·±çš„å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œè¯·æ±‚æ“ä½œç³»ç»Ÿè°ƒç”¨ç‰¹å®šçš„å‡½æ•°ã€‚è¯¥è¯·æ±‚å¯ä»¥é€šè¿‡å¦‚ä¸‹å‡½æ•°è°ƒç”¨å®Œæˆï¼š</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span><span class="p">)))(</span><span class="kt">int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">ä¸ºäº†åœ¨äº§ç”Ÿä¿¡å·æ—¶è°ƒç”¨ï¼Œè¿”å›ä¹‹å‰æ³¨å†Œçš„å‡½æ•°æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">å‡½æ•°å: signal
</span></span></span><span class="line"><span class="cl"><span class="cm">å‚æ•°ï¼šint signo,void(*func)(int)
</span></span></span><span class="line"><span class="cl"><span class="cm">è¿”å›ç±»å‹ï¼šå‚æ•°ç±»å‹ä¸ºintå‹ï¼Œè¿”å› void å‹å‡½æ•°æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>è°ƒç”¨ä¸Šè¿°å‡½æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç‰¹æ®Šæƒ…å†µï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç‰¹æ®Šæƒ…å†µä¸‹å°†è¦<strong>è°ƒç”¨çš„å‡½æ•°çš„åœ°å€å€¼</strong>ï¼ˆæŒ‡é’ˆï¼‰ã€‚å‘ç”Ÿç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨çš„æƒ…å†µæ—¶ï¼Œè°ƒç”¨ç¬¬äºŒä¸ªå‚æ•°æ‰€æŒ‡çš„å‡½æ•°ã€‚ä¸‹é¢ç»™å‡ºå¯ä»¥åœ¨ signal å‡½æ•°ä¸­æ³¨å†Œçš„éƒ¨åˆ†ç‰¹æ®Šæƒ…å†µã€‚</p>
<ul>
<li>SIGALRMï¼šå·²åˆ°é€šè¿‡è°ƒç”¨ alarm å‡½æ•°æ³¨å†Œæ—¶é—´</li>
<li>SIGINTï¼šè¾“å…¥ ctrl+c</li>
<li>SIGCHLDï¼šå­è¿›ç¨‹ç»ˆæ­¢</li>
</ul>
<p>è°ƒç”¨çš„å‡½æ•°çš„å‚æ•°åº”ä¸º int ï¼Œè¿”å›å€¼ç±»å‹åº”ä¸º void ã€‚åªæœ‰è¿™æ ·æ‰èƒ½æˆä¸º signal å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<ol start="2">
<li>æ¥ä¸‹æ¥ç¼–å†™ signal å‡½æ•°çš„è°ƒç”¨è¯­å¥ï¼Œåˆ†åˆ«å®Œæˆå¦‚ä¸‹ä¸¤ä¸ªè¯·æ±‚ï¼š
<ol>
<li>å·²åˆ°é€šè¿‡ alarm å‡½æ•°æ³¨å†Œæ—¶é—´ï¼Œè¯·è°ƒç”¨ timeout å‡½æ•°</li>
<li>è¾“å…¥ ctrl+c æ—¶è°ƒç”¨ keycontrol å‡½æ•°</li>
</ol>
</li>
</ol>
<p>ä»£è¡¨è¿™ 2 ç§æƒ…å†µçš„å¸¸æ•°åˆ†åˆ«ä¸º SIGALRM å’Œ SIGINT ï¼Œå› æ­¤æŒ‰å¦‚ä¸‹æ–¹å¼è°ƒç”¨ signal å‡½æ•°ã€‚</p>
<blockquote>
<p>signal(SIGALRM , timeout);
signal(SIGINT , keycontrol);</p>
</blockquote>
<ol start="3">
<li>æ³¨å†Œå¥½ä¿¡å·ä¹‹åï¼Œå‘å°„æ³¨å†Œä¿¡å·æ—¶ï¼ˆæ³¨å†Œçš„æƒ…å†µå‘ç”Ÿæ—¶ï¼‰ï¼Œæ“ä½œç³»ç»Ÿå°†è°ƒç”¨è¯¥ä¿¡å·å¯¹åº”çš„å‡½æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">alarm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è¿”å›0æˆ–ä»¥ç§’ä¸ºå•ä½çš„è· SIGALRM ä¿¡å·å‘ç”Ÿæ‰€å‰©æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1">// å¦‚æœè°ƒç”¨è¯¥å‡½æ•°çš„åŒæ—¶å‘å®ƒä¼ é€’ä¸€ä¸ªæ­£æ•´å‹å‚æ•°ï¼Œç›¸åº”æ—¶é—´åï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰å°†äº§ç”Ÿ SIGALRM ä¿¡å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// è‹¥å‘è¯¥å‡½æ•°ä¼ é€’ä¸º 0 ï¼Œåˆ™ä¹‹å‰å¯¹ SIGALRM ä¿¡å·çš„é¢„çº¦å°†å–æ¶ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// å¦‚æœé€šè¿‡è¯¥å‡½æ•°é¢„çº¦ä¿¡å·åæœªæŒ‡å®šè¯¥ä¿¡å·å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">// åˆ™ï¼ˆé€šè¿‡è°ƒç”¨ signal å‡½æ•°ï¼‰ç»ˆæ­¢è¿›ç¨‹ï¼Œä¸åšä»»ä½•å¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">timeout</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//ä¿¡å·å¤„ç†å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGALRM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Time out!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">alarm</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//ä¸ºäº†æ¯éš” 2 ç§’é‡å¤äº§ç”Ÿ SIGALRM ä¿¡å·ï¼Œåœ¨ä¿¡å·å¤„ç†å™¨ä¸­è°ƒç”¨ alarm å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">keycontrol</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//ä¿¡å·å¤„ç†å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGINT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;CTRL+C pressed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span> <span class="c1">//æ³¨å†Œä¿¡å·åŠç›¸åº”å¤„ç†å‡½æ•°ï¼Œæ³¨é‡Šè¯¥è¡Œ2såè¾“å‡ºalarm clockï¼Œç»ˆæ­¢è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">keycontrol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">alarm</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//é¢„çº¦ 2 ç§’å€™å‘å°„ SIGALRM ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;wait...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>  <span class="c1">// sleep 100s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>äº§ç”Ÿä¿¡å·æ—¶ï¼Œä¸ºäº†è°ƒç”¨ä¿¡å·å¤„ç†å™¨ï¼Œå°†å”¤é†’ç”±äºè°ƒç”¨ sleep å‡½æ•°è€Œè¿›å…¥é˜»å¡çŠ¶æ€çš„è¿›ç¨‹ã€‚<br />æœ¬æ¥ç³»ç»Ÿè¦ç¡çœ 100ç§’ï¼Œä½†æ˜¯åˆ°äº† alarm(2) è§„å®šçš„ä¸¤ç§’ä¹‹åï¼Œå°±ä¼šå”¤é†’ç¡çœ çš„è¿›ç¨‹ï¼Œ<strong>è¿›ç¨‹è¢«å”¤é†’äº†å°±ä¸ä¼šå†è¿›å…¥ç¡çœ çŠ¶æ€äº†</strong>ï¼Œæ‰€ä»¥å°±ä¸ç”¨ç­‰å¾…100ç§’ã€‚å¦‚æœæŠŠ timeout() å‡½æ•°ä¸­çš„ alarm(2) æ³¨é‡Šæ‰ï¼Œå°±ä¼šå…ˆè¾“å‡ºwait...ï¼Œç„¶åå†è¾“å‡ºTime out! (è¿™æ—¶å·²ç»è·³è¿‡äº†ç¬¬ä¸€æ¬¡çš„ sleep(100) ç§’),ç„¶åå°±çœŸçš„ä¼šç¡çœ 100ç§’ï¼Œå› ä¸ºæ²¡æœ‰å†å‘å‡º alarm(2) çš„ä¿¡å·ã€‚</p>
<h4 id="åˆ©ç”¨-sigaction-å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†"><a href="#åˆ©ç”¨-sigaction-å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†" class="anchor-link">#</a>åˆ©ç”¨ sigaction å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†</h4>
<blockquote>
<p>signal å‡½æ•°åœ¨ Unix ç³»åˆ—çš„ä¸åŒæ“ä½œç³»ç»Ÿå¯èƒ½å­˜åœ¨åŒºåˆ«ï¼Œä½† sigaction å‡½æ•°å®Œå…¨ç›¸åŒ</p>
</blockquote>
<p>å®é™…ä¸Šç°åœ¨å¾ˆå°‘ç”¨ signal å‡½æ•°ç¼–å†™ç¨‹åºï¼Œå®ƒåªæ˜¯ä¸ºäº†ä¿æŒå¯¹æ—§ç¨‹åºçš„å…¼å®¹ï¼Œä¸‹é¢ä»‹ç» sigaction å‡½æ•°ï¼Œåªè®²è§£å¯ä»¥æ›¿æ¢ signal å‡½æ•°çš„åŠŸèƒ½ã€‚</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">sigaction</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">sigaction</span> <span class="o">*</span><span class="n">act</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sigaction</span> <span class="o">*</span><span class="n">oldact</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1
</span></span></span><span class="line"><span class="cl"><span class="cm">act: å¯¹äºç¬¬ä¸€ä¸ªå‚æ•°çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼ˆä¿¡å·å¤„ç†å™¨ï¼‰ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">oldact: é€šè¿‡æ­¤å‚æ•°è·å–ä¹‹å‰æ³¨å†Œçš„ä¿¡å·å¤„ç†å‡½æ•°æŒ‡é’ˆï¼Œè‹¥ä¸éœ€è¦åˆ™ä¼ é€’ 0
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// struct sigaction  // sigactionç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1">//     void (*sa_handler)(int);  // ä¿å­˜ä¿¡å·å¤„ç†çš„å‡½æ•°æŒ‡é’ˆå€¼ï¼ˆåœ°å€å€¼ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1">//     sigset_t sa_mask;  // é˜²æ­¢åƒµå°¸è¿›ç¨‹ç½®0
</span></span></span><span class="line"><span class="cl"><span class="c1">//     int sa_flags;  // å¯çœ‹æºç çš„æ‰€æœ‰flag
</span></span></span><span class="line"><span class="cl"><span class="c1">// };
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">timeout</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGALRM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Time out!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">alarm</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sigaction</span> <span class="n">act</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>    <span class="c1">// ä¿å­˜å‡½æ•°æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>   <span class="c1">// sig empty setå°† sa_mask æˆå‘˜çš„æ‰€æœ‰ä½åˆå§‹åŒ–æˆ0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            <span class="c1">//sa_flags åŒæ ·åˆå§‹åŒ–æˆ 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// æ³¨å†Œ SIGALRM ä¿¡å·çš„å¤„ç†å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="n">alarm</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//2 ç§’åå‘ç”Ÿ SIGALRM ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;wait...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹"><a href="#åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹" class="anchor-link">#</a>åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹</h4>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">read_childproc</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// é”€æ¯å­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid_t</span> <span class="n">id</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Removed proc id: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>             <span class="c1">//å­è¿›ç¨‹çš„ pid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child send: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span> <span class="c1">//å­è¿›ç¨‹çš„è¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">sigaction</span> <span class="n">act</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">read_childproc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Hi I&#39;m child process 1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child 1 proc id: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Hi! I&#39;m child process 2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Child 2 proc id: %d </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">puts</span><span class="p">(</span><span class="s">&#34;wait&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>ç¨‹åºæ˜¯å…ˆåˆ›å»ºäº†ä¸¤ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ä¸”çˆ¶è¿›ç¨‹æ¯”å­è¿›ç¨‹æ‰§è¡Œå¿«ã€‚</p>
<blockquote>
<ol>
<li>wait</li>
<li>5s -&gt; wait</li>
<li>5s -&gt; wait</li>
<li>ä¸¤ä¸ªå­è¿›ç¨‹ç»ˆæ­¢ï¼Œå”¤é†’çˆ¶è¿›ç¨‹ -&gt; wait -&gt; wait ï¼ˆå”¤é†’åä¸ä¼‘çœ ï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡ä¸¤æ¬¡forå¾ªç¯ï¼Œè¿›å…¥æœ€åä¸€æ¬¡ä¼‘çœ ï¼‰</li>
<li>5s -&gt; ç¨‹åºä¸­æ­¢</li>
</ol>
</blockquote>
<h3 id="åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨"><a href="#åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨" class="anchor-link">#</a>åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨</h3>
<h4 id="åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹"><a href="#åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹" class="anchor-link">#</a>åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹</h4>
<p><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-10.png?imageMogr2/format/webp%7C" alt="image"><br />ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯å½“æœ‰å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼ˆè¿æ¥è¯·æ±‚ï¼‰ï¼Œå›å£°æœåŠ¡å™¨éƒ½åˆ›å»ºå­è¿›ç¨‹ä»¥æä¾›æœåŠ¡ã€‚å¦‚æœè¯·æ±‚çš„å®¢æˆ·ç«¯æœ‰ 5 ä¸ªï¼Œåˆ™å°†åˆ›å»º 5 ä¸ªå­è¿›ç¨‹æ¥æä¾›æœåŠ¡ï¼Œä¸ºäº†å®Œæˆè¿™äº›ä»»åŠ¡ï¼Œéœ€è¦ç»è¿‡å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼šå›å£°æœåŠ¡å™¨ç«¯ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€šè¿‡è°ƒç”¨ accept å‡½æ•°å—ç†è¿æ¥è¯·æ±‚</li>
<li>ç¬¬äºŒé˜¶æ®µï¼šæ­¤æ—¶è·å–çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºå¹¶ä¼ é€’ç»™å­è¿›ç¨‹</li>
<li>ç¬¬ä¸‰é˜¶æ®µï¼šè¿›ç¨‹åˆ©ç”¨ä¼ é€’æ¥çš„æ–‡ä»¶æè¿°ç¬¦æä¾›æœåŠ¡</li>
</ul>
<p><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpserv.c" target="_blank" rel="noopener">å®Œæ•´ä»£ç </a>ï¼Œå¯ä½¿ç”¨å¯¹åº”çš„<a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/echo_client.c" target="_blank" rel="noopener">echo_client</a></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">adr_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clnt_adr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">clnt_sock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clnt_adr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adr_sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">clnt_sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;new client connected...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span> <span class="c1">//æ­¤æ—¶ï¼Œçˆ¶å­è¿›ç¨‹åˆ†åˆ«å¸¦æœ‰ä¸€ä¸ªå¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// åˆ†é…å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//å­è¿›ç¨‹è¿è¡ŒåŒºåŸŸ, æ­¤éƒ¨åˆ†å‘å®¢æˆ·ç«¯æä¾›å›å£°æœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">close</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">);</span> <span class="c1">//å…³é—­æœåŠ¡å™¨å¥—æ¥å­—ï¼Œå› ä¸ºä»çˆ¶è¿›ç¨‹ä¼ é€’åˆ°äº†å­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="p">((</span><span class="n">str_len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">write</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">str_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;client disconnected...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">clnt_sock</span><span class="p">);</span> <span class="c1">//é€šè¿‡ accept å‡½æ•°åˆ›å»ºçš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦å·²ç»å¤åˆ¶ç»™å­è¿›ç¨‹ï¼Œå› æ­¤æœåŠ¡å™¨ç«¯è¦é”€æ¯è‡ªå·±çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><h4 id="é€šè¿‡-fork-å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦"><a href="#é€šè¿‡-fork-å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦" class="anchor-link">#</a>é€šè¿‡ fork å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</h4>
<p>ç¤ºä¾‹ä¸­ç»™å‡ºäº†é€šè¿‡ fork å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦çš„è¿‡ç¨‹ã€‚çˆ¶è¿›ç¨‹å°† 2 ä¸ªå¥—æ¥å­—ï¼ˆä¸€ä¸ªæ˜¯æœåŠ¡ç«¯å¥—æ¥å­—å¦ä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯å¥—æ¥å­—ï¼‰æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶ç»™äº†å­è¿›ç¨‹ã€‚<br />è°ƒç”¨ fork å‡½æ•°æ—¶èµ‹å€¼<strong>çˆ¶è¿›ç¨‹çš„æ‰€æœ‰èµ„æº</strong>ï¼Œä½†æ˜¯å¥—æ¥å­—ä¸æ˜¯å½’è¿›ç¨‹æ‰€æœ‰çš„ï¼Œè€Œæ˜¯<strong>å½’æ“ä½œç³»ç»Ÿæ‰€æœ‰</strong>ï¼Œåªæ˜¯è¿›ç¨‹æ‹¥æœ‰ä»£è¡¨ç›¸åº”å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<br /><img src="https://camo.githubusercontent.com/e8059964da650325509a86c00916dc588b147221b21e0355ca13e6ee8126f667/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32312f6b5037526a782e706e67#from=url&amp;id=SMxPg&amp;originHeight=363&amp;originWidth=513&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt="image"><br />å¦‚å›¾æ‰€ç¤ºï¼Œ1 ä¸ªå¥—æ¥å­—å­˜åœ¨ 2 ä¸ªæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œåªæœ‰ 2 ä¸ªæ–‡ä»¶æè¿°ç¬¦éƒ½ç»ˆæ­¢ï¼ˆé”€æ¯ï¼‰åï¼Œæ‰èƒ½é”€æ¯å¥—æ¥å­—ã€‚å¦‚æœç»´æŒå›¾ä¸­çš„çŠ¶æ€ï¼Œå³ä½¿<strong>å­è¿›ç¨‹é”€æ¯äº†ä¸å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿæ— æ³•é”€æ¯å¥—æ¥å­—</strong>ï¼ˆæœåŠ¡å™¨å¥—æ¥å­—åŒæ ·å¦‚æ­¤ï¼‰ã€‚å› æ­¤è°ƒç”¨ fork å‡½æ•°åï¼Œè¦å°†<strong>æ— å…³ç´§è¦çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦å…³æ‰</strong>ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š<br /><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-11.png?imageMogr2/format/webp%7C" alt=""></p>
<h3 id="åˆ†å‰²-tcp-çš„-io-ç¨‹åº"><a href="#åˆ†å‰²-tcp-çš„-io-ç¨‹åº" class="anchor-link">#</a>åˆ†å‰² TCP çš„ I/O ç¨‹åº</h3>
<p>æˆ‘ä»¬å·²ç»å®ç°çš„å›å£°<strong>å®¢æˆ·ç«¯</strong>çš„æ•°æ®å›å£°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å‘æœåŠ¡å™¨ä¼ è¾“æ•°æ®ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨ç«¯å›å¤ã€‚æ— æ¡ä»¶ç­‰å¾…ï¼Œç›´åˆ°æ¥æ”¶å®ŒæœåŠ¡å™¨ç«¯çš„å›å£°æ•°æ®åï¼Œæ‰èƒ½ä¼ è¾“ä¸‹ä¸€æ‰¹æ•°æ®ã€‚</p>
</blockquote>
<p>ä¼ è¾“æ•°æ®åè¦ç­‰å¾…æœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®ï¼Œå› ä¸ºç¨‹åºä»£ç ä¸­é‡å¤è°ƒç”¨äº† read å’Œ write å‡½æ•°ã€‚åªèƒ½è¿™ä¹ˆå†™çš„åŸå› ä¹‹ä¸€æ˜¯ï¼Œç¨‹åºåœ¨ 1 ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œç°åœ¨å¯ä»¥åˆ›å»ºå¤šä¸ªè¿›ç¨‹ï¼Œå› æ­¤å¯ä»¥åˆ†å‰²æ•°æ®æ”¶å‘è¿‡ç¨‹ã€‚åˆ†å‰²åè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br /><img src="https://camo.githubusercontent.com/60042284b80365905816ec0f9ca8bcf8695895916bad37b1d6d30a716e85ba0f/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32312f6b5062686b442e706e67#from=url&amp;id=Qy4jl&amp;originHeight=295&amp;originWidth=459&amp;originalType=binary&amp;ratio=1.2&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt="image"><br />ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå®¢æˆ·ç«¯çš„çˆ¶è¿›ç¨‹è´Ÿè´£æ¥æ”¶æ•°æ®ï¼Œé¢å¤–åˆ›å»ºçš„å­è¿›ç¨‹è´Ÿè´£å‘é€æ•°æ®ï¼Œåˆ†å‰²åï¼Œçˆ¶å­è¿›ç¨‹åˆ†åˆ«è´Ÿè´£è¾“å…¥è¾“å‡ºï¼Œè¿™æ ·ï¼Œæ— è®ºå®¢æˆ·ç«¯æ˜¯å¦ä»æœåŠ¡å™¨ç«¯æ¥æ”¶å®Œæ•°æ®éƒ½å¯ä»¥è¿›ç¨‹ä¼ è¾“ã€‚<br />åˆ†å‰² I/O ç¨‹åºçš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥æé«˜é¢‘ç¹äº¤æ¢æ•°æ®çš„ç¨‹åºæ€§èƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br /><img src="https://pic.keepjolly.com/halo/blog/2023/06/20230607220100-12.png?imageMogr2/format/webp%7C" alt=""><br />æ ¹æ®ä¸Šå›¾æ˜¾ç¤ºå¯ä»¥çœ‹å‡ºï¼Œåœ¨ç½‘ç»œä¸å¥½çš„æƒ…å†µä¸‹ï¼Œæ˜æ˜¾æå‡é€Ÿåº¦ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpclient.c" target="_blank" rel="noopener">å›å£°å®¢æˆ·ç«¯çš„ I/O åˆ†å‰²çš„ä»£ç å®ç°</a></li>
</ul>

            </div>

            


        </article>

        

        


        


        


        


        


        
    <footer class="minimal-footer">
        
            <div class="post-tag"><a href="/tags/tcp/" rel="tag" class="post-tag-link">#tcp</a> <a href="/tags/c-/" rel="tag" class="post-tag-link">#c</a> <a href="/tags/network/" rel="tag" class="post-tag-link">#network</a></div>
        
        
            <div class="post-category">
                <a href="/posts/" class="post-category-link active">posts</a> | 
            </div>
        
        
    </footer>



        


        


        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            

        </div>
        

        
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css">
<script>
    if (typeof renderMathInElement === 'undefined') {
        const getScript = (options) => {
            const script = document.createElement('script');
            script.defer = true;
            script.crossOrigin = 'anonymous';
            Object.keys(options).forEach((key) => {
                script[key] = options[key];
            });
            document.body.appendChild(script);
        };
        getScript({
            src: 'https:\/\/cdn.jsdelivr.net\/npm\/katex@0.13.0\/dist\/katex.min.js',
            onload: () => {
                getScript({
                    src: 'https:\/\/cdn.jsdelivr.net\/npm\/katex@0.13.0\/dist\/contrib\/mhchem.min.js',
                    onload: () => {
                        getScript({
                            src: 'https:\/\/cdn.jsdelivr.net\/npm\/katex@0.13.0\/dist\/contrib\/auto-render.min.js',
                            onload: () => {
                                renderKaTex();
                            }
                        });
                    }
                });
            }
        });
    } else {
        renderKaTex();
    }
    function renderKaTex() {
        renderMathInElement(
            document.body,
            {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "\\[", right: "\\]", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false}
                ]
            }
        );
    }
</script>










    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    let imgNodes = document.querySelectorAll('div.post-body img');
    imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

    mediumZoom(imgNodes, {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>









    </body>
</html>
